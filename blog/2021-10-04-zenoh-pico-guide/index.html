<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.png><meta name=msapplication-TileImage content="/safari-pinned-tab.png"><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../css/bootstrap-reboot.css><link rel=stylesheet href=../../css/bootstrap.css><link rel=stylesheet href=../../css/font-awesome.min.css><link rel=stylesheet href=../../css/ato.css><link rel=stylesheet href=../../css/syntax.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css><link rel=alternate type=application/rss+xml href=../../blog/index.xml><title>Zenoh goes embedded with zenoh-pico · Zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar navbar-expand navbar-dark flex-column flex-md-row ato-navbar"><a class=navbar-brand href=../../><img src=../../img/zenoh-dragon-bg-150x163.png class=align-middle alt></a><div class="collapse navbar-collapse"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../>Home</a></li><li class=nav-item><a class=nav-link href=../../docs/getting-started/first-app/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../usecases/>Use Cases</a></li><li class=nav-item><a class=nav-link href=../../community/>Community</a></li><li class=nav-item><a class=nav-link href=../../adopters/>Adopters</a></li><li class=nav-item><a class=nav-link href=../../media/>Media</a></li><li class=nav-item><a class="nav-link active" href=../../blog/2022-09-30-zenoh-bahamut/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/atolab_ target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://discord.gg/vSDSpqnbkm target=_blank rel=noopener aria-label=Discord><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Discord</title><path fill="currentcolor" d="M13.545 2.907a13.227 13.227.0 00-3.257-1.011.05.05.0 00-.052.025c-.141.25-.297.577-.406.833a12.19 12.19.0 00-3.658.0 8.258 8.258.0 00-.412-.833.051.051.0 00-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041.0 00-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276.0 003.995 2.02.05.05.0 00.056-.019c.308-.42.582-.863.818-1.329a.05.05.0 00-.01-.059.051.051.0 00-.018-.011 8.875 8.875.0 01-1.248-.595.05.05.0 01-.02-.066.051.051.0 01.015-.019c.084-.063.168-.129.248-.195a.05.05.0 01.051-.007c2.619 1.196 5.454 1.196 8.041.0a.052.052.0 01.053.007c.08.066.164.132.248.195a.051.051.0 01-.004.085 8.254 8.254.0 01-1.249.594.05.05.0 00-.03.03.052.052.0 00.003.041c.24.465.515.909.817 1.329a.05.05.0 00.056.019 13.235 13.235.0 004.001-2.02.049.049.0 00.021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034.0 00-.02-.019zm-8.198 7.307c-.789.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.45.73 1.438 1.613.0.888-.637 1.612-1.438 1.612zm5.316.0c-.788.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.451.73 1.438 1.613.0.888-.631 1.612-1.438 1.612z"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q target=_blank rel=noopener aria-label=Youtube><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Youtube</title><path fill="currentcolor" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01.0 011.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007.0 01-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309.0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007.0 01-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82.082 9.716A31.4 31.4.0 010 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007.0 011.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788.0 017.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120904581-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-41082619-2")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"blog","name":"Zenoh goes embedded with zenoh-pico","headline":"Zenoh goes embedded with zenoh-pico","datePublished":"2021-10-04 00:00:00 \u002b0000 UTC","dateModified":"2021-10-04 00:00:00 \u002b0000 UTC","url":"\/blog\/2021-10-04-zenoh-pico-guide\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"4044","wordCount":"1504","keywords":[],"description":"04 October 2021 -- Paris."}</script></header><div class="container-fluid ato-blog"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><div class="ato-docs-toggle d-md-none p-0 d-flex ml-3 collapsed align-item-center"><h1 class=ato-title>Zenoh goes embedded with zenoh-pico</h1><button class="btn btn-link" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><nav class="ato-links collapse" id=ato-docs-nav><div class="ato-toc-item active"><p class=ato-toc-link>Blog Posts</p><ul class="nav ato-sidenav"><li><a href=../../blog/2022-09-30-zenoh-bahamut/>Zenoh Bahamut takes flight!</a></li><li><a href=../../blog/2022-08-12-zenoh-serial/>There is Land Besides IP: How to Cross It with Zenoh</a></li><li><a href=../../blog/2022-06-09-zenoh-pico-above-and-beyond/>Zenoh-Pico: Above and Beyond</a></li><li><a href=../../blog/2022-04-14-rust-async-eval/>A Performance Evaluation on Rust Asynchronous Frameworks</a></li><li><a href=../../blog/2022-03-30-zenoh-mobility/>Mobility, Latency and Energy saving</a></li><li><a href=../../blog/2022-02-08-dragonbot/>DragonBotOne Egg Hatching with Zenoh and Zenoh-Pico</a></li><li><a href=../../blog/2021-11-09-ros2-zenoh-pico/>ROS 2 and microcontrollers integration via Zenoh-pico</a></li><li><a href=../../blog/2021-10-04-zenoh-pico-guide/>Zenoh goes embedded with zenoh-pico</a></li><li><a href=../../blog/2021-09-28-iac-experiences-from-the-trenches/>Indy Autonomous Challenge (IAC): Experiences from the Trenches</a></li><li><a href=../../blog/2021-07-13-zenoh-performance-async/>Zenoh performance: a stroll in Rust async wonderland</a></li><li><a href=../../blog/2021-07-05-zenoh-overhead/>Zenoh overhead: a story from our community</a></li><li><a href=../../blog/2021-06-14-zenoh-reliability/>Zenoh Reliability, Scalability and Congestion Control</a></li><li><a href=../../blog/2021-04-28-ros2-integration/>Integrating ROS2 with Eclipse zenoh</a></li><li><a href=../../blog/2021-03-23-discovery/>Minimizing Discovery Overhead in ROS2</a></li><li><a href=../../blog/2020-10-08-aithusa/>Zenoh Aithusa Hatched Out!</a></li><li><a href=../../blog/2020-06-29-zenoh-tidings/>Zenoh Tidings</a></li><li><a href=../../blog/2020-01-01-zenohtude/>A Year Full of Zenoh</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#prepare-your-environment>Prepare your environment</a></li><li><a href=#setup-your-project-folder>Setup your project folder</a><ul><li><a href=#zephyr>Zephyr</a></li><li><a href=#arduino>Arduino</a></li></ul></li><li><a href=#set-zenoh-pico-as-an-external-library-in-your-project>Set zenoh-pico as an external library in your project</a></li><li><a href=#implement-your-logic-using-zenoh-pico-libraries>Implement your logic using zenoh-pico libraries</a><ul><li><a href=#zephyr-1>Zephyr</a></li><li><a href=#arduino-1>Arduino</a></li></ul></li><li><a href=#build-and-upload>Build and upload</a></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>Zenoh goes embedded with zenoh-pico</h1><p class=ato-date>04 October 2021 -- Paris.</p><p>In this post, we will introduce <a href=https://github.com/eclipse-zenoh/zenoh-pico>zenoh-pico</a>, <strong>a lightweight implementation of Zenoh APIs in C, fully compatible with its Rust counterpart</strong>.</p><p>As a result of this work, we are happy to announce that we successfully deployed and tested Zenoh in <a href=https://www.zephyrproject.org>Zephyr</a> (reel_board and nucleo-f767zi) and <a href=https://www.arduino.cc>Arduino</a> (ESP32) compatible boards, with initial results showcasing a quite remarkable performance within the microcontrollers landscape:</p><ul><li>Memory footprint of only ~2.8% (nucleo-f767zi), ~9.2% (reel_board), and ~0.9% (ESP32).</li><li>Deliver more than 5.2k msg/s with a 8 bytes payload in ESP32.</li><li>Application-level throughput of ~9.2 Mbps (thus, saturating a 10 Mbps Ethernet link) with nucleo-f767zi.</li></ul><p>The reminder of this post will get you started with the environment setup, library installation, and project creation for your microcontrollers.</p><hr><h1 id=a-bit-of-context-for-zenoh-pico>A bit of context for zenoh-pico</h1><p><a href=https://zenoh.io>Zenoh</a> has been natively designed to introduce minimal wire overhead (check our <a href=https://zenoh.io/blog/2021-07-05-zenoh-overhead/>previous blog post</a>) and run across extremely constrained transports such as LPWAN and LowPAN, or directly over OSI Layer 2 (Data Link Layer) as well as to accommodate the resource constraints of embedded systems. However, since its very first public release, Zenoh Rust-based implementations have been focusing on providing high performance in widely used operating systems and platforms (check our <a href=https://zenoh.io/blog/2021-07-13-zenoh-performance-async/>previous blog post</a>). As a side note, Arduino was supported in the <a href=https://github.com/atolab/zhe>very first proof-of-concept for Zenoh</a>. But what about other constraints devices and microcontrollers?</p><p>Fear not more because <a href=https://github.com/eclipse-zenoh/zenoh-pico>zenoh-pico</a> has come a long way to provide such support. <strong>Zenoh-pico is a lightweight implementation of Zenoh APIs in C, fully compatible with its Rust counterpart.</strong></p><p>Internet of Things (IoT), home automation, and robotic systems appear among a set of use cases where Zenoh capabilities and features are a clear fit, paving the way for several benefits: support for push and pull communication models, geo distributed storage, and minimal wire overhead. However, most of these use cases rely on a variety of heterogeneous, low-powered, and resource constrained devices, making it a challenging environment to be supported. Just as an example, many IoT and smart home appliances being available in the market today (like smart plugs, motion sensors, door sensors, among others) are embedded with a ESP8266/ESP32 devices: the ESP32 is a dual-core 160MHz to 240MHz CPU with 320 KiB SRAM and 4MiB of built-in flash, whereas the ESP8266 is a single-core processor that runs at 80MHz with 80 KiB SRAM and 1 MiB of built-in flash. Similarly, many robotic systems are integrated with microcontrollers to control specific parts of the hardware as a complement to a more powerful device (e.g., Raspberry Pi) where all the logic is running.</p><ol><li><p><strong>But is the Rust-based implementation of Zenoh supported by microcontrollers?</strong>
Not yet, but <strong>zenoh-pico comes to rescue</strong>. Zenoh-pico is a lightweight implementation of the Zenoh protocol in C, fully compatible with its Rust counterpart. Its goal is three-fold: (i) provide a library implementation optimized for microcontrollers; (ii) provide a native C-based implementation (around 80% of embedded systems use C programming language); and (iii) keep the Rust-based implementation abstracted from the constraints imposed by microcontrollers.</p></li><li><p><strong>Being a lightweight implementation, what is it missing?</strong>
Currently, zenoh-pico does offer all the functionalities for you to implement a Zenoh <a href=./../docs/getting-started/key-concepts/#client-application>client mode</a> in microcontrollers. The support for peer-to-peer communication is still under planning and it does not feature the same level of message scheduling of the Rust stack.</p></li><li><p><strong>Which frameworks, platforms, or boards are currently supported?</strong>
So far, we have successfully tested zenoh-pico in <a href=https://www.zephyrproject.org>Zephyr</a> (<a href=https://docs.zephyrproject.org/latest/boards/arm/reel_board/doc/index.html>reel_board</a> and <a href=https://docs.zephyrproject.org/2.6.0/boards/arm/nucleo_f767zi/doc/index.html>nucleo-f767zi</a> boards) and <a href=https://www.arduino.cc>Arduino</a> (<a href=https://www.espressif.com/en/products/socs/esp32>ESP32</a>). No changes have been made in the core of zenoh-pico, requiring only the implementation of the system calls for your specific framework / platform.</p></li></ol><p><img src=../../img/blog-zenoh-pico-guide/boards.png alt=msg-sec></p><p>Well&mldr;enough talk, let&rsquo;s see how to do it!!</p><hr><h1 id=step-by-step-guide>Step by step guide</h1><p>In the following, we provide a step by step guide to build a Zenoh publisher.</p><h2 id=prepare-your-environment>Prepare your environment</h2><p>In order to manage and ease the process of building and deploying into a variety of microcontrollers, we suggest that PlatformIO is used as a supporting platform. Among other things, <a href=https://platformio.org>PlatformIO</a> provides a multi-platform and multi-architecture build system, supporting ~48 different platforms, ~26 frameworks, and ~1035 boards, without any external dependencies to the operating system.</p><p>You can check the super-quick installation instructions (as they call it) <a href=https://docs.platformio.org/en/latest//core/installation.html>here</a>.</p><h2 id=setup-your-project-folder>Setup your project folder</h2><p>Different platforms, frameworks, and boards require different project structures. But do not worry because you do not need to do it manually yourself. PlatformIO will give you a hand with that.</p><p>A typical PlatformIO project for must have the following structure:</p><h3 id=zephyr>Zephyr</h3><pre tabindex=0><code>project_dir
├── include
├── src
│    └── main.c
├── zephyr
│    ├── prj.conf
│    └── CMakeLists.txt
└── platformio.ini
</code></pre><h3 id=arduino>Arduino</h3><pre tabindex=0><code>project_dir
├── include
├── src
│    └── main.ino
└── platformio.ini
</code></pre><p>To setup this project structure, execute the following commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ <span style=color:#366>cd</span> /path/to/project_dir
</span></span><span style=display:flex><span>$ platformio init -b &lt;board_name&gt;  <span style=color:#09f;font-style:italic>#check board id by running platformio boards</span>
</span></span><span style=display:flex><span>$ platformio run
</span></span></code></pre></div><p>For the Zephyr framework, additional configurations must be provided. These are included in both prj.conf and CMakeLists.txt files. Example files for reel_board and nucleo_f767zi boards are provided in the documentation files of zenoh-pico. We will be keeping this list updated as we test zenoh-pico support on other boards.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cp /path/to/zenoh_pico/docs/zephyr/&lt;board&gt;/CMakelists.txt /path/to/project_dir/zephyr/
</span></span><span style=display:flex><span>$ cp /path/to/zenoh_pico/docs/zephyr/&lt;board&gt;/prj.conf /path/to/project_dir/zephyr/
</span></span></code></pre></div><h2 id=set-zenoh-pico-as-an-external-library-in-your-project>Set zenoh-pico as an external library in your project</h2><p>This is as simple as doing a symlink. Easy right?</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ln -s /path/to/zenoh_pico/ /path/to/project_dir/lib/zenoh-pico
</span></span></code></pre></div><h2 id=implement-your-logic-using-zenoh-pico-libraries>Implement your logic using zenoh-pico libraries</h2><p>Your code goes inside /path/to/project_dir/src/ folder. Note that some platforms/frameworks/boards do not follow the usual int main() for the programs’ entry point (e.g., ESP32).</p><p>Below you can find examples on how to implement a Zenoh publisher, publishing a message every 5 seconds.</p><h3 id=zephyr-1>Zephyr</h3><p>Examples provided with zenoh-pico work out of the box with Zephyr. However, note that in some boards, the board is still setting up the network when it starts running your program. In the following example, we solve this problem by sleeping for a couple of seconds.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;stdio.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;unistd.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;string.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;zenoh-pico.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>main</span>(<span style=color:#078;font-weight:700>int</span> argc, <span style=color:#078;font-weight:700>char</span> <span style=color:#555>**</span>argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    sleep(<span style=color:#f60>5</span>);
</span></span><span style=display:flex><span>    zn_properties_t <span style=color:#555>*</span>config <span style=color:#555>=</span> zn_config_default();
</span></span><span style=display:flex><span>    zn_properties_insert(config, ZN_CONFIG_PEER_KEY, z_string_make(<span style=color:#c30>&#34;tcp/10.0.0.1:7447&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    zn_session_t <span style=color:#555>*</span>s <span style=color:#555>=</span> zn_open(config);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#f60>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;Unable to open session!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>        exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Start the read session session lease loops
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    znp_start_read_task(s);
</span></span><span style=display:flex><span>    znp_start_lease_task(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>data <span style=color:#555>=</span> <span style=color:#c30>&#34;Publishing from Zephyr&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    zn_reskey_t reskey <span style=color:#555>=</span> zn_rid(zn_declare_resource(s, zn_rname(<span style=color:#c30>&#34;/demo/example/zenoh-pico-zephyr&#34;</span>)));
</span></span><span style=display:flex><span>    zn_publisher_t <span style=color:#555>*</span>pub <span style=color:#555>=</span> zn_declare_publisher(s, reskey);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (pub <span style=color:#555>==</span> <span style=color:#f60>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;Unable to declare publisher.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>        exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>while</span> (<span style=color:#f60>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        zn_write_ext(s, reskey, (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)data, strlen(data), Z_ENCODING_DEFAULT, Z_DATA_KIND_DEFAULT, zn_congestion_control_t_BLOCK);
</span></span><span style=display:flex><span>        sleep(<span style=color:#f60>5</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=arduino-1>Arduino</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;Arduino.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;WiFi.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>extern</span> <span style=color:#c30>&#34;C&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#099>#include</span> <span style=color:#099>&#34;zenoh-pico.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#define SSID &#34;SSID&#34;
</span></span></span><span style=display:flex><span><span style=color:#099>#define PASS &#34;PASSWORD&#34;
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Zenoh-specific parameters
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#099>#define MODE &#34;client&#34;
</span></span></span><span style=display:flex><span><span style=color:#099>#define PEER &#34;tcp/10.0.0.1:7447&#34;
</span></span></span><span style=display:flex><span><span style=color:#099>#define URI &#34;/demo/example/zenoh-pico-esp32&#34;
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span>zn_session_t <span style=color:#555>*</span>s <span style=color:#555>=</span> <span style=color:#366>NULL</span>;
</span></span><span style=display:flex><span>zn_reskey_t <span style=color:#555>*</span>reskey <span style=color:#555>=</span> <span style=color:#366>NULL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>setup</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Set WiFi in STA mode and trigger attachment
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    WiFi.mode(WIFI_STA);
</span></span><span style=display:flex><span>    WiFi.begin(SSID, PASS);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Keep trying until connected
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    <span style=color:#069;font-weight:700>while</span> (WiFi.status() <span style=color:#555>!=</span> WL_CONNECTED)
</span></span><span style=display:flex><span>    { }
</span></span><span style=display:flex><span>    delay(<span style=color:#f60>1000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    zn_properties_t <span style=color:#555>*</span>config <span style=color:#555>=</span> zn_config_default();
</span></span><span style=display:flex><span>    zn_properties_insert(config, ZN_CONFIG_MODE_KEY, z_string_make(MODE));
</span></span><span style=display:flex><span>    zn_properties_insert(config, ZN_CONFIG_PEER_KEY, z_string_make(PEER));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    s <span style=color:#555>=</span> zn_open(config);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#366>NULL</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    znp_start_read_task(s);
</span></span><span style=display:flex><span>    znp_start_lease_task(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>unsigned</span> <span style=color:#078;font-weight:700>long</span> rid <span style=color:#555>=</span> zn_declare_resource(s, zn_rname(URI));
</span></span><span style=display:flex><span>    reskey <span style=color:#555>=</span> (zn_reskey_t<span style=color:#555>*</span>)malloc(<span style=color:#069;font-weight:700>sizeof</span>(zn_reskey_t));
</span></span><span style=display:flex><span>    <span style=color:#555>*</span>reskey <span style=color:#555>=</span> zn_rid(rid);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    zn_publisher_t <span style=color:#555>*</span>pub <span style=color:#555>=</span> zn_declare_publisher(s, <span style=color:#555>*</span>reskey);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (pub <span style=color:#555>==</span> <span style=color:#366>NULL</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>loop</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    delay(<span style=color:#f60>5000</span>);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#366>NULL</span>)
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (reskey <span style=color:#555>==</span> <span style=color:#366>NULL</span>)
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>buf <span style=color:#555>=</span> <span style=color:#c30>&#34;Publishing data from ESP-32&#34;</span>;
</span></span><span style=display:flex><span>    zn_write(s, <span style=color:#555>*</span>reskey, (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)buf, strlen(buf));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=build-and-upload>Build and upload</h2><p>To build and upload the code into the board, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>platformio run
</span></span><span style=display:flex><span>platformio run -t upload
</span></span></code></pre></div><h1 id=first-look-on-memory-footprint-and-performance-results>First look on memory footprint and performance results</h1><p>The scarce memory and flash resources in microcontrollers stresses out the importance of the memory footprint of zenoh-pico. In the following table, you will find that zenoh-pico is introducing a memory footprint of only ~2.8% (nucleo-f767zi), ~9.2% (reel_board), and ~0.9% (ESP32).</p><table><thead><tr><th></th><th></th><th></th><th style=text-align:center><strong>reel_board (Zephyr)</strong></th><th></th><th></th><th style=text-align:center><strong>nucleo-f767zi (Zephyr)</strong></th><th></th><th></th><th style=text-align:center><strong>ESP32-D0WDQ6 (Arduino)</strong></th></tr></thead><tbody><tr><td><strong>Build-in Flash</strong></td><td></td><td></td><td style=text-align:center>1MiB</td><td></td><td></td><td style=text-align:center>2MiB</td><td></td><td></td><td style=text-align:center>4MiB</td></tr><tr><td><strong>Empty Binary (Zephyr-only)</strong></td><td></td><td></td><td style=text-align:center>68166 bytes</td><td></td><td></td><td style=text-align:center>127344 bytes</td><td></td><td></td><td style=text-align:center>385859 bytes</td></tr><tr><td><strong>Zenoh Publisher</strong></td><td></td><td></td><td style=text-align:center>164654 bytes</td><td></td><td></td><td style=text-align:center>186942 bytes</td><td></td><td></td><td style=text-align:center>423161 bytes</td></tr></tbody></table><p>In terms of application-level throughput (i.e., goodput), ESP32 board was able to deliver more than 5.2k msg/s with a 8 bytes payload, while for a payload of 4096 bytes nucleo-f767zi board the link gets up to 9.2 Mbps (thus, saturating the 10 Mbps Ethernet link).</p><p><img src=../../img/blog-zenoh-pico-guide/preliminary-benchmark.png alt=msg-sec></p><p>*Note: reel_board and nucleo-f767zi are using Ethernet while ESP32 WiFi.</p><hr><h1 id=conclusion>Conclusion</h1><p>As developers, we know how important it is to keep things efficient and optimized, especially when it comes to microcontrollers, while providing as transparent support as possible (no one likes to be setting up or significantly changing their projects).</p><p>Summarizing:</p><ul><li>zenoh-pico provides a lightweight implementation of Zenoh, allowing you to integrate Zenoh client functionalities in your embedded systems natively in C.</li><li>We have successfully tested it in <a href=https://www.zephyrproject.org>Zephyr</a> (reel_board and nucleo-f767zi) and <a href=https://www.arduino.cc>Arduino</a> (ESP32) compatible boards</li><li>Initial performance tests hints for a quite remarkable performance within the microcontrollers landscape.<ul><li>Memory footprint of only ~2.8% (nucleo-f767zi), ~9.2% (reel_board), and ~0.9% (ESP32).</li><li>Deliver more than 5.2k msg/s with a 8 bytes payload in ESP32.</li><li>Application-level throughput of ~9.2 Mbps (in an 10 Mbps Ethernet link) with nucleo-f767zi.</li></ul></li></ul><p>Help us increase the number of supported platforms, frameworks, and boards. We will provide all the support you need either in <a href=https://github.com/eclipse-zenoh>GitHub</a> or <a href=https://discord.gg/cY4nVjUd>Discord</a>.</p><p><a href=https://github.com/cguimaraes/><strong>&ndash;CG</strong></a></p><div class=ato-next><b>Next up</b>: <a href=../../blog/2021-09-28-iac-experiences-from-the-trenches/>Indy Autonomous Challenge (IAC): Experiences from the Trenches</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../img/eclipse-foundation.svg style=width:120px></a></p><p><a href=https://zettascale.tech target=_blank><img src=../../img/zettascale-dark.svg style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i>
GitHub</a></p><p><a href=https://discord.gg/vSDSpqnbkm><i class="fa fa fa-comments-o" aria-hidden=true></i>
Discord</a></p><p><a href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q><i class="fa fa-youtube-play" aria-hidden=true></i> Youtube</a></p><p><a href=../../docs/overview/what-is-zenoh><i class="fa fa-info-circle" aria-hidden=true></i> About</a></p></div><div class=col-md-2><p><img src=../../img/zenoh-dragon-150x163.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2022 Eclipse Foundation</p><p>Built with <a href=https://gohugo.io/ target=_blank>HUGO</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script>
<script src=../../js/bootstrap.min.js></script>
<script src=../../js/highlight.min.js></script>
<script>$(function(){$("pre code").each(function(e,t){if(t.className.indexOf("language-rust")>=0){for(var s="",n=t.textContent.split(`
`),e=0;e<n.length;e++){if(n[e].indexOf("# ")==0||n[e]=="#")continue;s+=n[e].trimRight()+`
`}t.textContent=s.replace(/\n\n\n/g,`

`).trimRight()}hljs.highlightBlock(t)})})</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script>
<script type=text/javascript>docsearch({apiKey:"d7b5b785798fe748621bcaa8301a2201",indexName:"zenoh",inputSelector:"#search-input",debug:!1})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41082619-2","auto"),ga("send","pageview"))</script></body></html>