<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.png><meta name=msapplication-TileImage content="/safari-pinned-tab.png"><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../css/bootstrap-reboot.css><link rel=stylesheet href=../../css/bootstrap.css><link rel=stylesheet href=../../css/font-awesome.min.css><link rel=stylesheet href=../../css/ato.css><link rel=stylesheet href=../../css/syntax.css><link rel=alternate type=application/rss+xml href=../../blog/index.xml><title>ROS 2 and microcontrollers integration via Zenoh-pico · Zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar-expand navbar-dark d-flex flex-column flex-md-row align-items-md-center ato-navbar"><div class="d-flex flex-row justify-content-between pl-2 pr-2"><a class=navbar-brand href=../../><img src=../../img/zenoh-dragon-bg-150x163.png class=align-middle alt></a>
<button class="btn btn-link d-md-none p-0" type=button data-toggle=collapse data-target=#ato-nav aria-controls=ato-nav aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><div class="ato-links collapse pl-4 pl-md-0" id=ato-nav><ul class="navbar-nav flex-column flex-md-row"><li class=nav-item><a class=nav-link href=../../>Home</a></li><li class=nav-item><a class=nav-link href=../../docs/getting-started/first-app/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../usecases/>Use Cases</a></li><li class=nav-item><a class=nav-link href=../../community/>Community</a></li><li class=nav-item><a class=nav-link href=../../adopters/>Adopters</a></li><li class=nav-item><a class=nav-link href=../../media/>Media</a></li><li class=nav-item><a class="nav-link active" href=../../blog/2023-04-04-letsencrypt/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/zettascaletech target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://discord.gg/2GJ958VuHs target=_blank rel=noopener aria-label=Discord><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Discord</title><path fill="currentcolor" d="M13.545 2.907a13.227 13.227.0 00-3.257-1.011.05.05.0 00-.052.025c-.141.25-.297.577-.406.833a12.19 12.19.0 00-3.658.0 8.258 8.258.0 00-.412-.833.051.051.0 00-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041.0 00-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276.0 003.995 2.02.05.05.0 00.056-.019c.308-.42.582-.863.818-1.329a.05.05.0 00-.01-.059.051.051.0 00-.018-.011 8.875 8.875.0 01-1.248-.595.05.05.0 01-.02-.066.051.051.0 01.015-.019c.084-.063.168-.129.248-.195a.05.05.0 01.051-.007c2.619 1.196 5.454 1.196 8.041.0a.052.052.0 01.053.007c.08.066.164.132.248.195a.051.051.0 01-.004.085 8.254 8.254.0 01-1.249.594.05.05.0 00-.03.03.052.052.0 00.003.041c.24.465.515.909.817 1.329a.05.05.0 00.056.019 13.235 13.235.0 004.001-2.02.049.049.0 00.021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034.0 00-.02-.019zm-8.198 7.307c-.789.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.45.73 1.438 1.613.0.888-.637 1.612-1.438 1.612zm5.316.0c-.788.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.451.73 1.438 1.613.0.888-.631 1.612-1.438 1.612z"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q target=_blank rel=noopener aria-label=Youtube><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Youtube</title><path fill="currentcolor" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01.0 011.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007.0 01-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309.0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007.0 01-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82.082 9.716A31.4 31.4.0 010 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007.0 011.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788.0 017.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120904581-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-41082619-2")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"blog","name":"ROS 2 and microcontrollers integration via Zenoh-pico","headline":"ROS 2 and microcontrollers integration via Zenoh-pico","datePublished":"2021-11-09 00:00:00 \u002b0000 UTC","dateModified":"2021-11-09 00:00:00 \u002b0000 UTC","url":"\/blog\/2021-11-09-ros2-zenoh-pico\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"9099","wordCount":"1327","keywords":[],"description":"09 November 2021 -- Paris."}</script></header><div class="container-fluid ato-blog"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><div class="ato-docs-toggle d-md-none p-0 d-flex ml-3 collapsed align-item-center"><h1 class=ato-title>ROS 2 and microcontrollers integration via Zenoh-pico</h1><button class="btn btn-link" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><nav class="ato-links collapse" id=ato-docs-nav><div class="ato-toc-item active"><p class=ato-toc-link>Blog Posts</p><ul class="nav ato-sidenav"><li><a href=../../blog/2023-04-04-letsencrypt/>Securing Zenoh with LetsEncrypt: A Comprehensive Guide</a></li><li><a href=../../blog/2023-03-21-zenoh-vs-mqtt-kafka-dds/>Comparing the Performance of Zenoh, MQTT, Kafka, and DDS</a></li><li><a href=../../blog/2023-02-10-zenoh-flow/>Data Flow programming with Zenoh-Flow</a></li><li><a href=../../blog/2023-01-17-zenoh-wireshark/>The Blue Dragon meets the Wire’s Shark</a></li><li><a href=../../blog/2023-01-10-zenoh-charmander/>Zenoh Charmander is coming to town</a></li><li><a href=../../blog/2022-11-29-zenoh-alignment/>Keeping storages aligned in Zenoh</a></li><li><a href=../../blog/2022-09-30-zenoh-bahamut/>Zenoh Bahamut takes flight!</a></li><li><a href=../../blog/2022-08-12-zenoh-serial/>There is Land Besides IP: How to Cross It with Zenoh</a></li><li><a href=../../blog/2022-06-09-zenoh-pico-above-and-beyond/>Zenoh-Pico: Above and Beyond</a></li><li><a href=../../blog/2022-04-14-rust-async-eval/>A Performance Evaluation on Rust Asynchronous Frameworks</a></li><li><a href=../../blog/2022-03-30-zenoh-mobility/>Mobility, Latency and Energy saving</a></li><li><a href=../../blog/2022-02-08-dragonbot/>DragonBotOne Egg Hatching with Zenoh and Zenoh-Pico</a></li><li><a href=../../blog/2021-11-09-ros2-zenoh-pico/>ROS 2 and microcontrollers integration via Zenoh-pico</a></li><li><a href=../../blog/2021-10-04-zenoh-pico-guide/>Zenoh goes embedded with zenoh-pico</a></li><li><a href=../../blog/2021-09-28-iac-experiences-from-the-trenches/>Indy Autonomous Challenge (IAC): Experiences from the Trenches</a></li><li><a href=../../blog/2021-07-13-zenoh-performance-async/>Zenoh performance: a stroll in Rust async wonderland</a></li><li><a href=../../blog/2021-07-05-zenoh-overhead/>Zenoh overhead: a story from our community</a></li><li><a href=../../blog/2021-06-14-zenoh-reliability/>Zenoh Reliability, Scalability and Congestion Control</a></li><li><a href=../../blog/2021-04-28-ros2-integration/>Integrating ROS2 with Eclipse zenoh</a></li><li><a href=../../blog/2021-03-23-discovery/>Minimizing Discovery Overhead in ROS2</a></li><li><a href=../../blog/2020-10-08-aithusa/>Zenoh Aithusa Hatched Out!</a></li><li><a href=../../blog/2020-06-29-zenoh-tidings/>Zenoh Tidings</a></li><li><a href=../../blog/2020-01-01-zenohtude/>A Year Full of Zenoh</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#zenoh-powered-immersive-controller>Zenoh-powered Immersive Controller</a></li></ul><ul><li><a href=#1-pinout-and-connections>1. Pinout and Connections</a></li><li><a href=#2-code>2. Code</a></li><li><a href=#3-setting-up-the-infrastructure-and-the-turtlebot--turtlesim>3. Setting up the infrastructure and the turtlebot / turtlesim</a></li><li><a href=#4-demonstration>4. Demonstration</a></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>ROS 2 and microcontrollers integration via Zenoh-pico</h1><p class=ato-date>09 November 2021 -- Paris.</p><p>In a <a href=https://zenoh.io/blog/2021-04-28-ros2-integration/>previous blog</a>, we showed how you can easily write native Zenoh applications and seamlessly interact with ROS 2 applications. This was exemplified by developing a native Zenoh teleoperation application to control a ROS 2 powered robot, namely a <a href=https://www.robot-advance.com/EN/actualite-turtlebot3-burger-by-robotis-149.htm>turtlebot</a> or its simulation counterpart <a href=http://wiki.ros.org/turtlesim>turtlesim</a>, from anywhere in the world. In this blog, we will go one step further by trying to make it cool and fun &ndash; together with a bit of nostalgia.</p><p>As a result of this work, we are unveiling the capabilities of Zenoh to bridge the gap between ROS 2 and microcontroller environments by providing a lightweight and unified data-centric protocol coupled with its own implementation Zenoh middleware solution and DDS bridge. In other words, ROS 2 users can extend their application towards microcontrollers via Zenoh.</p><p>The reminder of this blog will recap the main concepts of our previous blog and guide you towards its extension to use <a href=https://github.com/eclipse-zenoh/zenoh-pico>Zenoh-pico</a> and microcontrollers.</p><hr><h1 id=rewinding-time>Rewinding time</h1><p>In the scenario described below, the Zenoh teleoperation application discovers the Zenoh/DDS bridge via its scouting protocol that leverages UDP multicast - when available. Once discovered, a TCP connection is established between the app and the bridge. But the Zenoh application can also be configured to directly establish a TCP connection with a known host, without relying on scouting protocol. Thus it can connect directly to the bridge (if reachable) or to 1 or more Zenoh routers that will route the Zenoh communications between the application and the bridge.</p><p><img src=../../img/blog-ros2-zenoh-pico/scenario-zenoh-dds.png alt=msg-sec></p><p>At this stage, the user can make use of its keyboard to control the robot (just like in a game).</p><h1 id=it-seems-like-the-80scan-we-fast-forward-in-time>It seems like the 80s&mldr;can we fast forward in time?</h1><p>Remember that it is a proof-of-concept demo to show the capabilities of Zenoh. Still, we have to agree that the turtlesim and teleoperation via keyboard is too much 80s.
So, how to forward this demo in time&mldr;</p><ul><li>in the 90s, we had an explosion of game controllers</li><li>in the 00s, we had an explosion of pads, joysticks, racing wheels, and other gaming interfaces.</li><li>in the 10s, we had an explosion of motion controller</li><li>in the 20s, we are having an explosion of immersive experiences.</li></ul><p>At this point, you might have guessed already that we are going for an immersive experience.</p><h2 id=zenoh-powered-immersive-controller>Zenoh-powered Immersive Controller</h2><p>As announced in a <a href=https://zenoh.io/blog/2021-10-04-zenoh-pico-guide/>previous blog</a>, Zenoh-pico is available as a lightweight implementation of Zenoh APIs in C, fully compatible with its Rust counterpart. It mainly targets embedded systems and, in particular, microcontrollers.</p><p>Thanks to the combination of Zenoh-pico, microcontrollers and a couple of sensors, we extended our initial teleoperation controller and embedded it anywhere. In doing so, we are going to show you how to control a turtlebot and its simulation counterpart turtlesim by means of hand gestures. For example, the small size of the microcontroller and sensors make them almost imperceptible to the eye and touch, and can be easily embedded in a regular glove for a truly immersive experience.</p><p>Wouldn’t it be cool and fun to have the power in your hand? How many of you have ever tried to use the force as a Jedi or telekinetic powers as an X-Men?</p><p>Here is a short video of our Zenoh-powered Immersive Controller prototype being used to control the turtlebot.</p><p><img src=../../img/blog-ros2-zenoh-pico/turtlebot-real-demo.gif alt=msg-sec></p><hr><h1 id=show-me-how-to-do-it-myself>Show me how to do it myself</h1><p>All you need is an <a href=https://www.espressif.com/en/products/socs/esp32>ESP32</a>, a MPU-6050 accelerometer and gyroscope module and, of course, <a href=https://github.com/eclipse-zenoh/zenoh-pico>zenoh-pico</a>. Note that, even if you decide to use other microcontrollers or sensors, all Zenoh-related code and components remain unchanged.</p><p>By providing a set of abstractions for pub/sub, geo distributed storage, query, and evals, Zenoh really simplifies the development of distributed applications. In other words, Zenoh internally handles all the inherent complexities of a distributed system and data distribution, keeping your life as a developer much simpler.</p><h2 id=1-pinout-and-connections>1. Pinout and Connections</h2><p>The first step is to wire the ESP32 with the MPU-6050 sensor. Here are some guidelines:</p><table><thead><tr><th style=text-align:center><strong>MPU-6050</strong></th><th></th><th></th><th style=text-align:center><strong>ESP32</strong></th></tr></thead><tbody><tr><td style=text-align:center>VCC</td><td></td><td></td><td style=text-align:center>3V3</td></tr><tr><td style=text-align:center>GND</td><td></td><td></td><td style=text-align:center>GND</td></tr><tr><td style=text-align:center>SCL</td><td></td><td></td><td style=text-align:center>GPIO22</td></tr><tr><td style=text-align:center>SDA</td><td></td><td></td><td style=text-align:center>GPIO21</td></tr></tbody></table><table><thead><tr><th style=text-align:center></th><th></th><th></th><th style=text-align:center></th></tr></thead><tbody><tr><td style=text-align:center><img src=../../img/blog-ros2-zenoh-pico/diagram-pinout.png alt=msg-sec></td><td></td><td></td><td style=text-align:center><img src=../../img/blog-ros2-zenoh-pico/real-pinout.png alt=msg-sec></td></tr></tbody></table><h2 id=2-code>2. Code</h2><p>You can find the steps on how to set up your project in our <a href=https://zenoh.io/blog/2021-10-04-zenoh-pico-guide/>previous blog</a>. Then, you just need this little snippet of code to make it work. Note that, Zenoh-related code is only around 12 lines, while the remaining code is related to reading the values of the sensor, pre-processing them, and creating the Twist message.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;Arduino.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;WiFi.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;Wire.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;MPU6050_tockn.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>extern</span> <span style=color:#c30>&#34;C&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#099>#include</span> <span style=color:#099>&#34;zenoh-pico.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// WiFi-specific parameters
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#099>#define SSID &#34;SSID&#34;
</span></span></span><span style=display:flex><span><span style=color:#099>#define PASS &#34;PASSWORD&#34;
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Zenoh-specific parameters
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#099>#define MODE &#34;client&#34;
</span></span></span><span style=display:flex><span><span style=color:#099>#define URI &#34;/rt/cmd_vel&#34;
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Measurement specific parameters
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#099>#define X_SCALING_FACTOR 100.0
</span></span></span><span style=display:flex><span><span style=color:#099>#define X_MAX_VALUE 0.20
</span></span></span><span style=display:flex><span><span style=color:#099>#define X_MIN_VALUE -0.20
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#099>#define Y_SCALING_FACTOR 10.0
</span></span></span><span style=display:flex><span><span style=color:#099>#define Y_MAX_VALUE 2.80
</span></span></span><span style=display:flex><span><span style=color:#099>#define Y_MIN_VALUE -2.80
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span>MPU6050 mpu(Wire);
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>double</span> offset_x <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>double</span> offset_y <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zn_session_t <span style=color:#555>*</span>s <span style=color:#555>=</span> <span style=color:#366>NULL</span>;
</span></span><span style=display:flex><span>zn_reskey_t <span style=color:#555>*</span>reskey <span style=color:#555>=</span> <span style=color:#366>NULL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>setup</span>(<span style=color:#078;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Set WiFi in STA mode and trigger attachment
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    WiFi.mode(WIFI_STA);
</span></span><span style=display:flex><span>    WiFi.begin(SSID, PASS);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>while</span> (WiFi.status() <span style=color:#555>!=</span> WL_CONNECTED)
</span></span><span style=display:flex><span>        delay(<span style=color:#f60>1000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Initialize MPU6050
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    Wire.begin();
</span></span><span style=display:flex><span>    mpu.begin();
</span></span><span style=display:flex><span>    mpu.calcGyroOffsets(<span style=color:#366>true</span>);
</span></span><span style=display:flex><span>    mpu.update();
</span></span><span style=display:flex><span>    offset_x <span style=color:#555>=</span> mpu.getAccAngleX();
</span></span><span style=display:flex><span>    offset_y <span style=color:#555>=</span> mpu.getAccAngleY();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Initialize Zenoh Session and other parameters
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    zn_properties_t <span style=color:#555>*</span>config <span style=color:#555>=</span> zn_config_default();
</span></span><span style=display:flex><span>    zn_properties_insert(config, ZN_CONFIG_MODE_KEY, z_string_make(MODE));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    s <span style=color:#555>=</span> zn_open(config);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#366>NULL</span>)
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    znp_start_read_task(s);
</span></span><span style=display:flex><span>    znp_start_lease_task(s);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>unsigned</span> <span style=color:#078;font-weight:700>long</span> rid <span style=color:#555>=</span> zn_declare_resource(s, zn_rname(URI));
</span></span><span style=display:flex><span>    reskey <span style=color:#555>=</span> (zn_reskey_t<span style=color:#555>*</span>)malloc(<span style=color:#069;font-weight:700>sizeof</span>(zn_reskey_t));
</span></span><span style=display:flex><span>    <span style=color:#555>*</span>reskey <span style=color:#555>=</span> zn_rid(rid);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    delay(<span style=color:#f60>1000</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>loop</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    delay(<span style=color:#f60>20</span>);
</span></span><span style=display:flex><span>    mpu.update();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>double</span> linear_x <span style=color:#555>=</span> (mpu.getAccAngleX() <span style=color:#555>-</span> offset_x) <span style=color:#555>/</span> X_SCALING_FACTOR;
</span></span><span style=display:flex><span>    linear_x <span style=color:#555>=</span> min(max(linear_x, X_MIN_VALUE), X_MAX_VALUE);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (linear_x <span style=color:#555>&lt;</span> <span style=color:#f60>0.10</span> <span style=color:#555>&amp;&amp;</span> linear_x <span style=color:#555>&gt;</span> <span style=color:#555>-</span><span style=color:#f60>0.10</span>)
</span></span><span style=display:flex><span>            linear_x <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>double</span> linear_y <span style=color:#555>=</span> (mpu.getAccAngleY() <span style=color:#555>-</span> offset_y) <span style=color:#555>/</span> Y_SCALING_FACTOR;
</span></span><span style=display:flex><span>    linear_y <span style=color:#555>=</span> min(max(linear_y, Y_MIN_VALUE), Y_MAX_VALUE);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (linear_y <span style=color:#555>&lt;</span> <span style=color:#f60>0.5</span> <span style=color:#555>&amp;&amp;</span> linear_y <span style=color:#555>&gt;</span> <span style=color:#555>-</span><span style=color:#f60>0.5</span>)
</span></span><span style=display:flex><span>            linear_y <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Twist measure;
</span></span><span style=display:flex><span>    measure.linear.x <span style=color:#555>=</span> linear_x;
</span></span><span style=display:flex><span>    measure.linear.y <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span>    measure.linear.z <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span>    measure.angular.x <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span>    measure.angular.y <span style=color:#555>=</span> <span style=color:#f60>0.0</span>;
</span></span><span style=display:flex><span>    measure.angular.z <span style=color:#555>=</span> linear_y;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint8_t</span> twist_serialized_size <span style=color:#555>=</span> <span style=color:#f60>4</span> <span style=color:#555>+</span> <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#078;font-weight:700>double</span>) <span style=color:#555>*</span> <span style=color:#f60>6</span>;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> buf[twist_serialized_size];
</span></span><span style=display:flex><span>    serialize_twist(<span style=color:#555>&amp;</span>measure, buf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#366>NULL</span> <span style=color:#555>||</span> reskey <span style=color:#555>==</span> <span style=color:#366>NULL</span>)
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    zn_write(s, <span style=color:#555>*</span>reskey, (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)buf, twist_serialized_size);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Note:</strong> auxiliary structs and serialization functions are missing in the previous snippet. For the full code, including the adaptations for the turtlesim, please check the code under <a href=https://github.com/eclipse-zenoh/zenoh-demos/tree/master/ROS2/zenoh-pico-teleop-gyro>https://github.com/eclipse-zenoh/zenoh-demos/tree/master/ROS2/zenoh-pico-teleop-gyro</a></p><h2 id=3-setting-up-the-infrastructure-and-the-turtlebot--turtlesim>3. Setting up the infrastructure and the turtlebot / turtlesim</h2><p>In order to set up the infrastructure and the turtlebot / turtle in different configurations, follow the steps described in our <a href=https://zenoh.io/blog/2021-04-28-ros2-integration/>previous blog</a>. However, note that Zenoh-pico currently supports client mode only (a lightweight peer mode is coming soon). As such, you might need to deploy at least one Zenoh router to which your microcontroller application will need to connect to. The minimum steps are shown below:</p><ol><li>Start the turtlesim or turtlebot3 burger:<ul><li>ros2 run turtlesim turtlesim_node # turtlesim</li><li>ros2 launch turtlebot3_bringup robot.launch.py # turtlebot3 burger</li></ul></li><li>Start the Zenoh router:<ul><li>zenohd</li></ul></li><li>Start the Zenoh/DDS bridge if not included as a plugin in Zenoh router<ul><li>zenoh-bridge-dds</li></ul></li><li>Build, Upload and Start Ros2Teleop in your microcontroller<ul><li>platformio run -t upload</li></ul></li><li>Move the sensor to drive the robot</li></ol><h2 id=4-demonstration>4. Demonstration</h2><p>If everything goes well, you might be able to control the robot just like in the video below.</p><table><thead><tr><th>Turtlebot3 Burger</th><th></th><th></th><th style=text-align:center>Turtlesim</th></tr></thead><tbody><tr><td><img src=../../img/blog-ros2-zenoh-pico/turtlebot-test-demo.gif alt=msg-sec></td><td></td><td></td><td style=text-align:center><img src=../../img/blog-ros2-zenoh-pico/turtlesim-test-demo.gif alt=msg-sec></td></tr></tbody></table><p>Really cool, isn’t it?!</p><hr><h1 id=conclusion>Conclusion</h1><p>Although it seems a very simple demonstration, it is supported by several state-of-the-art technologies and protocols that are running under the hood. For you as a developer, being abstracted from all of them means that you can focus on the core business of your application.</p><p>Moreover, Zenoh and Zenoh-pico are bridging the gap between ROS 2 and microcontroller environments, allowing ROS 2 users to make use of all its capabilities within their applications. Summarizing some key points:</p><ul><li><a href=https://github.com/eclipse-zenoh/zenoh>Zenoh</a> is hatching as a powerful and yet low overhead data-centric solution, extremely flexible to accommodate a wide range of distinct applications and use cases.</li><li><a href=https://github.com/eclipse-zenoh/zenoh-pico>Zenoh-pico</a> allows you to integrate Zenoh functionalities in your embedded systems and microcontrollers natively in C.</li><li><a href=https://github.com/eclipse-zenoh/zenoh-plugin-dds>Zenoh bridge for DDS</a> allows to (1) bridge DDS communications through Zenoh, and (2) reduce by up to 99.97% the discovery traffic between the nodes.</li></ul><p>Tell us about your ideas on how to unlock the power of microcontrollers. We will provide all the support you need either in <a href=https://github.com/eclipse-zenoh>GitHub</a> or <a href=https://discord.gg/cY4nVjUd>Discord</a>.</p><p><a href=https://github.com/cguimaraes/><strong>&ndash;CG</strong></a>
<a href=https://github.com/gabrik/><strong>&ndash;GB</strong></a>
<a href=https://github.com/JEnoch/><strong>&ndash;JE</strong></a></p><div class=ato-next><b>Next up</b>: <a href=../../blog/2021-10-04-zenoh-pico-guide/>Zenoh goes embedded with zenoh-pico</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../img/eclipse-foundation.svg style=width:120px></a></p><p><a href=https://zettascale.tech target=_blank><img src=../../img/zettascale-dark.svg style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i>
GitHub</a></p><p><a href=https://discord.gg/vSDSpqnbkm><i class="fa fa fa-comments-o" aria-hidden=true></i>
Discord</a></p><p><a href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q><i class="fa fa-youtube-play" aria-hidden=true></i> Youtube</a></p><p><a href=../../docs/overview/what-is-zenoh><i class="fa fa-info-circle" aria-hidden=true></i> About</a></p></div><div class=col-md-2><p><img src=../../img/zenoh-dragon-150x163.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2022 Eclipse Foundation</p><p>Built with <a href=https://gohugo.io/ target=_blank>HUGO</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script>
<script src=../../js/bootstrap.min.js></script>
<script src=../../js/highlight.min.js></script>
<script>$(function(){$("pre code").each(function(e,t){if(t.className.indexOf("language-rust")>=0){for(var s="",n=t.textContent.split(`
`),e=0;e<n.length;e++){if(n[e].indexOf("# ")==0||n[e]=="#")continue;s+=n[e].trimRight()+`
`}t.textContent=s.replace(/\n\n\n/g,`

`).trimRight()}hljs.highlightBlock(t)})})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41082619-2","auto"),ga("send","pageview"))</script></body></html>