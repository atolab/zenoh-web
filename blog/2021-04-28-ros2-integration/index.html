<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.png color=#7da7d8><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../css/bootstrap-reboot.css><link rel=stylesheet href=../../css/bootstrap.css><link rel=stylesheet href=../../css/font-awesome.min.css><link rel=stylesheet href=../../css/ato.css><link rel=stylesheet href=../../css/syntax.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css><link rel=alternate type=application/rss+xml href=../../blog/index.xml><title>Integrating ROS2 with Eclipse zenoh · zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar navbar-expand navbar-dark flex-column flex-md-row ato-navbar"><a class=navbar-brand href=../../><img src=../../img/zenoh-dragon-bg.png class=align-middle alt></a><div class="collapse navbar-collapse"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../>Home</a></li><li class=nav-item><a class=nav-link href=../../docs/getting-started/key-concepts/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../community/>Community</a></li><li class=nav-item><a class="nav-link active" href=../../blog/2021-07-05-zenoh-overhead/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/atolab_ target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://gitter.im/atolab/zenoh target=_blank rel=noopener aria-label=Gitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Gitter</title><path fill="currentcolor" d="M8.501 4.001H10.5V24H8.501V4.001zm6.999.0V24h-2V4.001h2zM3.5.0h2.001v15H3.5V0zm15 4.001h2V15h-2V4.001z"/></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120904581-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41082619-2');</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"blog","name":"Integrating ROS2 with Eclipse zenoh","headline":"Integrating ROS2 with Eclipse zenoh","datePublished":"2021-04-28 00:00:00 \x2b0000 UTC","dateModified":"2021-04-28 00:00:00 \x2b0000 UTC","url":"\/blog\/2021-04-28-ros2-integration\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"28284","wordCount":"1845","keywords":[],"description":"28 April 2021 -- Paris."}</script></header><div class="container-fluid ato-blog"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><div class="ato-docs-toggle d-md-none p-0 d-flex ml-3 collapsed align-item-center"><h1 class=ato-title>Integrating ROS2 with Eclipse zenoh</h1><button class="btn btn-link" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><nav class="ato-links collapse" id=ato-docs-nav><div class="ato-toc-item active"><p class=ato-toc-link>Blog Posts</p><ul class="nav ato-sidenav"><li><a href=../../blog/2021-07-05-zenoh-overhead/>Zenoh overhead: a story from our community</a></li><li><a href=../../blog/2021-06-14-zenoh-reliability/>Zenoh Reliability, Scalability and Congestion Control</a></li><li><a href=../../blog/2021-04-28-ros2-integration/ class=active>Integrating ROS2 with Eclipse zenoh</a></li><li><a href=../../blog/2021-03-23-discovery/>Minimizing Discovery Overhead in ROS2</a></li><li><a href=../../blog/2020-10-08-aithusa/>Zenoh Aithusa Hatched Out!</a></li><li><a href=../../blog/2020-06-29-zenoh-tidings/>Zenoh Tidings</a></li><li><a href=../../blog/2020-01-01-zenohtude/>A Year Full of Zenoh</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#what-does-the-zenohdds-bridge-do->What does the zenoh/DDS bridge do ?</a></li><li><a href=#how-to-encodedecode-ros2-messages->How to encode/decode ROS2 messages ?</a></li><li><a href=#show-me-some-code>Show me some code</a></li><li><a href=#how-do-i-use-zenoh-to-operate-my-robot-from-anywhere-in-the-world->How do I use zenoh to operate my robot from anywhere in the world ?</a><ul><li><a href=#1-opening-a-tcp-port-and-redirecting-it-to-the-zenohdds-bridge>1. Opening a TCP port and redirecting it to the zenoh/DDS bridge</a></li><li><a href=#2-behind-a-nat-leverage-a-zenoh-router-in-the-cloud>2. Behind a NAT? Leverage a zenoh router in the cloud!</a></li><li><a href=#3-what-if-my-cloud-instance-crashes-or-reboot->3. What if my cloud instance crashes or reboot ?</a></li><li><a href=#4-other-deployments-eg-mesh-network>4. Other deployments (e.g. mesh network)</a></li></ul></li><li><a href=#one-more-thing>One more thing&mldr;</a></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>Integrating ROS2 with Eclipse zenoh</h1><p class=ato-date>28 April 2021 -- Paris.</p><p>In our <a href=../2021-03-23-discovery/>previous blog</a> we demonstrated how the <a href=https://github.com/eclipse-zenoh/zenoh-plugin-dds>zenoh bridge for DDS</a> allows to (1) bridge DDS communications through zenoh, and (2) reduce by up to 99.97% the discovery traffic between the nodes.</p><p>The previous blog was focusing on demonstrating the advantages of using zenoh as the mean for ROS2-to-ROS2 communication over wireless technologies. In this blog, we’ll go one step further and will demonstrate how you can easily write native zenoh applications —meaning that has no dependencies on ROS2 — and seamlessly interact with <a href=https://docs.ros.org/en/foxy/index.html>ROS2</a> applications. Finally, we will show how you can extend your communication to Internet scale, allowing to cover all the typical cases for Robot-to-anything (R2X) communication.</p><hr><h2 id=what-does-the-zenohdds-bridge-do->What does the zenoh/DDS bridge do ?</h2><p>The zenoh/DDS bridge is leveraging <a href=https://github.com/eclipse-cyclonedds/cyclonedds>CycloneDDS</a> to discover the DDS readers and writers declared by the ROS2 application. For each discovered DDS entity the bridge creates a mirror DDS-entity — in other terms it creates a reader when discovering a writer and vice-versa. Additionally the bridge maps the DDS topics read and written by the discovered DDS entities on zenoh resources and performs the proper declarations.</p><p>As example, let’s consider the <a href=http://docs.ros.org/en/foxy/Tutorials/Turtlesim/Introducing-Turtlesim.html>turtlesim</a> package used in the ROS2 Tutorial:</p><ul><li>By default the turtlesim node has a ROS2 Publisher on topic <code>/rosout</code>. As per <a href=https://design.ros2.org/articles/topic_and_service_names.html#ros-specific-namespace-prefix>ROS2 conventions</a> this maps to a DDS Writer on topic <code>rt/rosout</code>. Consequently the zenoh/DDS bridge declares a DDS Reader on the same topic with matching QoS. This DDS Reader will receive all publications from the turtlesim on this topic and re-publish those on a zenoh resource having <code>/rt/rosout</code> as a key.</li><li>The turtlesim also has a ROS2 Subscriber on topic <code>/turtle1/cmd_vel</code> that maps as a DDS Reader on <code>rt/turtle1/cmd_vel</code>. The zenoh/DDS bridge declares a DDS Writer on the same topic, and a zenoh subscriber for the key <code>/rt/turtle1/cmd_vel</code>. This zenoh subscriber will receive all publications with this key from any zenoh application and re-publish those to DDS on topic <code>rt/turtle1/cmd_vel</code> to be received by the ROS2 subscriber on <code>/turtle1/cmd_vel</code>.</li></ul><hr><h2 id=how-to-encodedecode-ros2-messages->How to encode/decode ROS2 messages ?</h2><p>You may have noticed that the zenoh/DDS bridge doesn’t need to be compiled with any ROS2 message definition. That is because the bridge doesn’t need to interpret the ROS2 messages. It just forward the data payload as is. As a consequence a zenoh application that needs to publish/subscribe to ROS2 will need to encode/decode those messages.</p><p>For those who are curious about the details, the ROS2 messages are encoded for DDS following the <a href>OMG DDSI-RTPS specification (see §10)</a> in <a href=https://www.omg.org/spec/CORBA/3.4/Interoperability/PDF>CDR format (see §9.3)</a>. But fortunately, you usually don&rsquo;t need to implement a CDR encoder/decoder, since there are libraries for this in most languages
(<a href=https://pypi.org/project/pycdr/>Python</a>, <a href=https://crates.io/crates/cdr>Rust</a>, <a href=https://www.nuget.org/packages/CSCDR>C#</a>, <a href=https://www.npmjs.com/package/jscdr>Javascript</a>&mldr; )</p><hr><h2 id=show-me-some-code>Show me some code</h2><p>OK, let&rsquo;s do a zenoh &ldquo;teleop&rdquo; app in Python for a start. It will publish Twist messages to the turtlesim&rsquo;s <code>/turtle1/cmd_vel</code> Subscriber and subscribe to Log messages published by the turtlesim&rsquo;s <code>/rosout</code> Publisher.</p><p>All that you need is:</p><ul><li>A host with ROS2 environment and:<ul><li>the <a href=http://docs.ros.org/en/foxy/Tutorials/Turtlesim/Introducing-Turtlesim.html>turtlesim</a> package</li><li>the <a href=https://github.com/eclipse-zenoh/zenoh-plugin-dds/#trying-it-out>zenoh/DDS bridge</a></li></ul></li><li>Another host in the same LAN with (or you can use the same host, but that&rsquo;s less fun&mldr;):<ul><li>the <a href=https://github.com/eclipse-zenoh/zenoh-python#how-to-install-it>zenoh Python API</a> and pycdr installed -<br>just do: <code>pip install eclipse-zenoh pycdr</code></li></ul></li></ul><p><em><strong>Note</strong>: currently you need to build the zenoh/DDS bridge yourself. But we will provide pre-built binaries for main platforms soon. Once built, the <code>zenoh-bridge-dds</code> executable is generated in the <code>zenoh-plugin-dds/target/release</code> sub-directory.</em></p><p>Now:</p><ol><li><p><strong>Start the turtlesim</strong> on host 1:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ros2 run turtlesim turtlesim_node
</code></pre></div></li><li><p><strong>Start the zenoh/DDS bridge</strong> on host 1:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#033>RUST_LOG</span><span style=color:#555>=</span>info zenoh-bridge-dds -m peer
</code></pre></div><p>The <code>RUST_LOG=info</code> environment variable is to activate the logs at &ldquo;info&rdquo; level. You should see such logs proving that the bridge discovered the turtlesim&rsquo;s Publishers and Subscribers:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#555>[</span>2021-04-13T13:11:58Z INFO  zenoh_bridge_dds<span style=color:#555>]</span> New route:
   DDS <span style=color:#c30>&#39;rt/rosout&#39;</span> <span style=color:#555>=</span>&gt; zenoh <span style=color:#c30>&#39;/rt/rosout&#39;</span> <span style=color:#555>(</span><span style=color:#033>rid</span><span style=color:#555>=</span>19<span style=color:#555>)</span> with type<span style=color:#c30>&#39;rcl_interfaces::msg::dds_::Log_&#39;</span>
<span style=color:#555>[</span>2021-04-13T13:11:58Z INFO  zenoh_bridge_dds<span style=color:#555>]</span> New route:
   zenoh <span style=color:#c30>&#39;/rt/turtle1/cmd_vel&#39;</span> <span style=color:#555>=</span>&gt; DDS <span style=color:#c30>&#39;rt/turtle1/cmd_vel&#39;</span> with type<span style=color:#c30>&#39;geometry_msgs::msg::dds_::Twist_&#39;</span>
</code></pre></div></li><li><p>On host 2, run the following <strong>Python</strong> script:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#09f;font-style:italic># Some required imports</span>
<span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>zenoh</span>
<span style=color:#069;font-weight:700>from</span> <span style=color:#0cf;font-weight:700>zenoh.net</span> <span style=color:#069;font-weight:700>import</span> config, SubInfo, Reliability, SubMode
<span style=color:#069;font-weight:700>from</span> <span style=color:#0cf;font-weight:700>pycdr</span> <span style=color:#069;font-weight:700>import</span> cdr
<span style=color:#069;font-weight:700>from</span> <span style=color:#0cf;font-weight:700>pycdr.types</span> <span style=color:#069;font-weight:700>import</span> int8, int32, uint32, float64

<span style=color:#09f;font-style:italic># Declare the types of Twist message to be encoded and published via zenoh</span>
<span style=color:#99f>@cdr</span>
<span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Vector3</span>:
   x: float64
   y: float64
   z: float64

<span style=color:#99f>@cdr</span>
<span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Twist</span>:
   linear: Vector3
   angular: Vector3

<span style=color:#09f;font-style:italic># Declare the types of Log message to be decoded and subscribed to via zenoh</span>
<span style=color:#99f>@cdr</span>
<span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Time</span>:
   sec: int32
   nanosec: uint32

<span style=color:#99f>@cdr</span>
<span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Log</span>:
   stamp: Time
   level: int8
   name: <span style=color:#366>str</span>
   msg: <span style=color:#366>str</span>
   <span style=color:#366>file</span>: <span style=color:#366>str</span>
   function: <span style=color:#366>str</span>
   line: uint32

<span style=color:#09f;font-style:italic># Initiate the zenoh-net API</span>
session <span style=color:#555>=</span> zenoh<span style=color:#555>.</span>net<span style=color:#555>.</span>open({})

<span style=color:#09f;font-style:italic># Declare the callback and the subscriber for Log messages with key &#39;/rt/rosout&#39;</span>
<span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>rosout_callback</span>(sample):
    log <span style=color:#555>=</span> Log<span style=color:#555>.</span>deserialize(sample<span style=color:#555>.</span>payload)
    <span style=color:#069;font-weight:700>print</span>(<span style=color:#c30>&#39;[{}.{}] [{}]: {}&#39;</span><span style=color:#555>.</span>format(
        log<span style=color:#555>.</span>stamp<span style=color:#555>.</span>sec, log<span style=color:#555>.</span>stamp<span style=color:#555>.</span>nanosec, log<span style=color:#555>.</span>name, log<span style=color:#555>.</span>msg))

sub_info <span style=color:#555>=</span> SubInfo(Reliability<span style=color:#555>.</span>Reliable, SubMode<span style=color:#555>.</span>Push)
sub <span style=color:#555>=</span> session<span style=color:#555>.</span>declare_subscriber(<span style=color:#c30>&#39;/rt/rosout&#39;</span>, sub_info, rosout_callback)

<span style=color:#09f;font-style:italic># Publish a Twist message with key &#39;/rt/turtle1/cmd_vel&#39; to make the turtlesim to move forward</span>
t <span style=color:#555>=</span> Twist(linear<span style=color:#555>=</span>Vector3(x<span style=color:#555>=</span><span style=color:#f60>2.0</span>, y<span style=color:#555>=</span><span style=color:#f60>0.0</span>, z<span style=color:#555>=</span><span style=color:#f60>0.0</span>),
          angular<span style=color:#555>=</span>Vector3(x<span style=color:#555>=</span><span style=color:#f60>0.0</span>, y<span style=color:#555>=</span><span style=color:#f60>0.0</span>, z<span style=color:#555>=</span><span style=color:#f60>0.0</span>))<span style=color:#555>.</span>serialize()
session<span style=color:#555>.</span>write(<span style=color:#c30>&#39;/rt/turtle1/cmd_vel&#39;</span>, t)

<span style=color:#09f;font-style:italic># Make it move forward until it hits the wall!!</span>
session<span style=color:#555>.</span>write(<span style=color:#c30>&#39;/rt/turtle1/cmd_vel&#39;</span>, t)
session<span style=color:#555>.</span>write(<span style=color:#c30>&#39;/rt/turtle1/cmd_vel&#39;</span>, t)
</code></pre></div></li></ol><p>You can see more complete versions of a &ldquo;teleop&rdquo; code with various options and arrows key-pressed listener here:</p><ul><li>in Python: <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-python-teleop>https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-python-teleop</a></li><li>in Rust: <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-rust-teleop>https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-rust-teleop</a></li><li>in C#: <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-csharp-teleop>https://github.com/atolab/zenoh-demo/tree/main/ROS2/zenoh-csharp-teleop</a></li></ul><hr><h2 id=how-do-i-use-zenoh-to-operate-my-robot-from-anywhere-in-the-world->How do I use zenoh to operate my robot from anywhere in the world ?</h2><p>In the scenario described above, the zenoh application discovers the zenoh/DDS bridge via its scouting protocol that leverages UDP multicast - when available. Once discovered, a TCP connection is established between the app and the bridge</p><div style=display:flex;justify-content:left;align-items:center><img src=../../../img/blog-RO2-integration/multicast-discovery.png alt="multicast discovery" width=800></img></div><p>But the zenoh application can also be configured to directly establish a TCP connection with a known host, without relying on scouting protocol. Thus it can connect directly to the bridge (if reachable) or to 1 or more zenoh routers that will route the zenoh communications between the application and the bridge.</p><p>Let&rsquo;s see the different use cases:</p><h3 id=1-opening-a-tcp-port-and-redirecting-it-to-the-zenohdds-bridge>1. Opening a TCP port and redirecting it to the zenoh/DDS bridge</h3><p>Assuming you can configure your internet connection to open a public TCP port (e.g. 7447) and redirect it to the host running the zenoh/DDS bridge, you can do the following deployment:</p><div style=display:flex;justify-content:left;align-items:center><img src=../../../img/blog-RO2-integration/open-port.png alt="open port" width=950></img></div><p>Where:</p><ul><li><p>the zenoh/DDS bridge is started with this command:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>zenoh-bridge-dds -m peer -l tcp/0.0.0.0:7447
</code></pre></div><p>The <code>-l</code> option makes the bridge to listen for TCP connection on port 7447.</p></li><li><p>our zenoh teleop application must be configured to connect to the public IP and port of the bridge.<br>In Python, this is done adding a <code>"peer"</code> configuration when initializing the API:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#09f;font-style:italic># note: replace &#34;123.4.5.6&#34; with your public IP in here:</span>
session <span style=color:#555>=</span> zenoh<span style=color:#555>.</span>net<span style=color:#555>.</span>open({<span style=color:#c30>&#34;peer&#34;</span>: <span style=color:#c30>&#34;tcp/123.4.5.6:7447&#34;</span>})
</code></pre></div><p>With the &ldquo;teleop&rdquo; demos provided <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2>here</a>, you can use the <code>-e tcp/123.4.5.6:7447</code> program argument.</p></li></ul><h3 id=2-behind-a-nat-leverage-a-zenoh-router-in-the-cloud>2. Behind a NAT? Leverage a zenoh router in the cloud!</h3><p>If you can&rsquo;t open a public TCP port in your LAN, let&rsquo;s use a zenoh router in a public cloud instance that will intermediate the communications between the bridge and the zenoh application:</p><div style=display:flex;justify-content:left;align-items:center><img src=../../../img/blog-RO2-integration/router-in-cloud.png alt="router in cloud" width=800></img></div><p>To deploy this:</p><ol><li><p>Pick your favorite cloud provider and provision a Ubuntu 64-bit VM with a public IP.</p></li><li><p>Install the zenoh router in this VM following those instructions:
<a href=http://zenoh.io/docs/getting-started/installation/#ubuntu-or-any-debian-x86-64>http://zenoh.io/docs/getting-started/installation/#ubuntu-or-any-debian-x86-64</a></p></li><li><p>Run the zenoh router in your vm staring:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>zenohd
</code></pre></div><p>Now the zenoh router is reachable on via the public IP of your VM on port <strong>7447</strong> by default.</p></li><li><p>Run the zenoh/DDS bridge as a router client, making it to connect the zenoh router:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#09f;font-style:italic># note: replace &#34;123.4.5.6&#34; with your cloud VM&#39;s public IP in here:</span>
zenoh-bridge-dds -m client -e tcp/123.4.5.6:7447
</code></pre></div></li><li><p>our zenoh teleop application must be also configured as a router client to connect the zenoh router:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#09f;font-style:italic># note: replace &#34;123.4.5.6&#34; with your cloud VM&#39;s public IP in here:</span>
session <span style=color:#555>=</span> zenoh<span style=color:#555>.</span>net<span style=color:#555>.</span>open({<span style=color:#c30>&#34;mode&#34;</span>: <span style=color:#c30>&#34;client&#34;</span> , <span style=color:#c30>&#34;peer&#34;</span>: <span style=color:#c30>&#34;tcp/123.4.5.6:7447&#34;</span>})
</code></pre></div><p>With the &ldquo;teleop&rdquo; demos provided <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2>here</a>, you can use the <code>-m client -e tcp/123.4.5.6:7447</code> program arguments.</p></li></ol><h3 id=3-what-if-my-cloud-instance-crashes-or-reboot->3. What if my cloud instance crashes or reboot ?</h3><p>Just deploy several inter-connected zenoh routers in different cloud instances:</p><div style=display:flex;justify-content:left;align-items:center><img src=../../../img/blog-RO2-integration/cloud-crash-2.gif alt="cloud crash" width=1000></img></div><ol><li>Run a first zenoh router in 1st cloud:<div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>zenohd
</code></pre></div></li><li>Run another zenoh router in 2nd cloud, connected to zenoh router in 1st cloud:<div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>zenohd -e tcp/123.4.5.6:7447
</code></pre></div></li><li>Run the zenoh/DDS bridge as a router client, configured with the 2 zenoh routers&rsquo; locators:<div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#09f;font-style:italic># note: replace &#34;123.4.5.6&#34; and &#34;123.7.8.9&#34; with your cloud VMs&#39; public IPs in here:</span>
zenoh-bridge-dds -m client -e tcp/123.4.5.6:7447 -e tcp/123.7.8.9:7447
</code></pre></div></li><li>our zenoh teleop application must be also configured as a router client and with the 2 zenoh routers&rsquo; locators:<div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#09f;font-style:italic># note: replace &#34;123.4.5.6&#34; and &#34;123.7.8.9&#34; with your cloud VMs&#39; public IPs in here:</span>
session <span style=color:#555>=</span> zenoh<span style=color:#555>.</span>net<span style=color:#555>.</span>open({<span style=color:#c30>&#34;mode&#34;</span>: <span style=color:#c30>&#34;client&#34;</span> , <span style=color:#c30>&#34;peer&#34;</span>: <span style=color:#c30>&#34;tcp/123.4.5.6:7447,tcp/123.7.8.9:7447&#34;</span>})
</code></pre></div><p>With the &ldquo;teleop&rdquo; demos provided <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2>here</a>, you can use the <code>-m client -e tcp/123.4.5.6:7447 -e tcp/123.7.8.9:7447</code> program arguments.</p></li></ol><p>Now, both bridge and zenoh application will connect to the 1st configured locator (i.e. router in 1st cloud). If this one fails, they will both failover to the router in 2nd cloud.</p><h3 id=4-other-deployments-eg-mesh-network>4. Other deployments (e.g. mesh network)</h3><p>Notice that in the previous use case, as the 2 zenoh routers are interconnected, the zenoh/DDS bridge and the zenoh application don&rsquo;t need to be connected to the same router to communicate with each other. If they are connected to distinct routers, those ones will route the zenoh traffic between them, and the bridge and the application will still communicate with each other.</p><p>Actually, you can deploy the zenoh/DDS bridge, your teleop application and one or more interconnected zenoh router in all the ways described in the <a href=../../docs/getting-started/key-concepts/#deployment-units>zenoh documentation</a>. Just use the <code>-m peer</code> or <code>-m client</code> argument for the <code>zenoh-bridge-dds</code> to configure it as a peer or a client. And similarly for your zenoh teleop application.</p><hr><h2 id=one-more-thing>One more thing&mldr;</h2><p>Did I mention that you can easily communicate with more than 1 robot using Eclipse zenoh? Let&rsquo;s make several independent turtlesims move in a synchronous way!</p><p>Start as many turtlesim you want, each using its own ROS domain<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#033>ROS_DOMAIN_ID</span><span style=color:#555>=</span><span style=color:#f60>1</span> ros2 run turtlesim turtlesim_node
<span style=color:#033>ROS_DOMAIN_ID</span><span style=color:#555>=</span><span style=color:#f60>2</span> ros2 run turtlesim turtlesim_node
<span style=color:#033>ROS_DOMAIN_ID</span><span style=color:#555>=</span><span style=color:#f60>3</span> ros2 run turtlesim turtlesim_node
...
</code></pre></div><p>For each turtlesim, run a zenoh/DDS bridge using the same ROS domain (via <code>-d</code> argument) and specifying a prefix that will be added to each zenoh key (via <code>-s</code> argument):</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>zenoh-bridge-dds -d <span style=color:#f60>1</span> -m peer -s /bot-1
zenoh-bridge-dds -d <span style=color:#f60>2</span> -m peer -s /bot-2
zenoh-bridge-dds -d <span style=color:#f60>3</span> -m peer -s /bot-3
...
</code></pre></div><p>Now for turtlesim on domain 1, the <code>/rosout</code> and <code>/turtle1/cmd_vel</code> ROS2 topics are mapped respectively to <code>/bot-1/rt/rosout</code> and <code>/bot-1/rt/turtle1/cmd_vel</code> zenoh keys. And similarly but with a different prefix for each turtlesim.</p><p>The zenoh trick to rule them all is to just subscribe and publish via <a href=http://zenoh.io/docs/manual/abstractions/#path-expression>path expressions</a>. In the Python code shown above:</p><ul><li>subscribe to <code>'/**/rosout'</code> instead of <code>'/rt/rosout'</code></li><li>publish Twist messages to <code>'/**/cmd_vel'</code> instead of <code>'/rt/turtle1/cmd_vel'</code></li></ul><p>You can also test this with the &ldquo;teleop&rdquo; demos provided <a href=https://github.com/atolab/zenoh-demo/tree/main/ROS2>here</a>, using the <code>--rosout='/**/rosout' --cmd_vel='/**/cmd_vel'</code> program arguments.</p><p><a href=https://github.com/JEnoch><strong>&ndash;JE</strong></a></p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><strong>Why 1 domain per robot ?</strong><br>In most of the cases, you don&rsquo;t need the robots to communicate with each other. But if you let them to use the same <code>ROS_DOMAIN_ID</code>, their DDS entities in the robots will anyway exchange discovery informations with each other leading to a lot of unecessary traffic that could be problematic over wireless communications (as seen in our previous blog). The simplest way to avoid such traffic is to use distinct domains. Other solutions could be specific network configuration, or specific DDS configuration. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><div class=ato-next><b>Next up</b>: <a href=/blog/2021-03-23-discovery/>Minimizing Discovery Overhead in ROS2</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../img/eclipse-foundation.svg style=width:120px></a></p><p><a href=https://www.adlinktech.com target=_blank><img src=https://cdn.adlinktech.com/webupd/en/Upload/logo.png style=width:120px></a></p><p><a href=https://www.futurewei.com target=_blank><img src=../../img/futurewei-logo.png style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i>GitHub</a></p><p><a href=https://gitter.im/atolab/zenoh><i class="fa fa fa-comments-o" aria-hidden=true></i>Gitter</a></p><p><a href=../../docs/overview/><i class="fa fa-info-circle" aria-hidden=true></i>About</a></p></div><div class=col-md-2><p><img src=../../img/zenoh-dragon.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2021 Eclipse Foundation</p><p>Build with <a href=https://gohugo.io/ target=_blank>HUGO</a></p><p>Theme inspired from: <a href=https://tokio.rs/ target=_blank>Tokio website theme</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script><script src=../../js/bootstrap.min.js></script><script src=../../js/highlight.js></script><script>$(function(){$("pre code").each(function(i,block){if(block.className.indexOf('language-rust')>=0){var new_content='';var lines=block.textContent.split('\n');for(var i=0;i<lines.length;i++){if(lines[i].indexOf('# ')==0||lines[i]=='#'){continue}
new_content+=lines[i].trimRight()+'\n';}
block.textContent=new_content.replace(/\n\n\n/g,"\n\n").trimRight();}
hljs.highlightBlock(block);});});</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({apiKey:'d7b5b785798fe748621bcaa8301a2201',indexName:'zenoh',inputSelector:'#search-input',debug:false});</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-41082619-2','auto');ga('send','pageview');}</script></body></html>