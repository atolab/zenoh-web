<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.png color=#7da7d8><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../css/bootstrap-reboot.css><link rel=stylesheet href=../../css/bootstrap.css><link rel=stylesheet href=../../css/font-awesome.min.css><link rel=stylesheet href=../../css/ato.css><link rel=stylesheet href=../../css/syntax.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css><link rel=alternate type=application/rss+xml href=../../blog/index.xml><title>Zenoh overhead: a story from our community Â· zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar navbar-expand navbar-dark flex-column flex-md-row ato-navbar"><a class=navbar-brand href=../../><img src=../../img/zenoh-dragon-bg.png class=align-middle alt></a><div class="collapse navbar-collapse"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../>Home</a></li><li class=nav-item><a class=nav-link href=../../docs/getting-started/key-concepts/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../community/>Community</a></li><li class=nav-item><a class=nav-link href=../../adopters/>Adopters</a></li><li class=nav-item><a class="nav-link active" href=../../blog/2021-06-14-zenoh-reliability/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd" /></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/atolab_ target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor" /></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://gitter.im/atolab/zenoh target=_blank rel=noopener aria-label=Gitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Gitter</title><path fill="currentcolor" d="M8.501 4.001H10.5V24H8.501V4.001zm6.999.0V24h-2V4.001h2zM3.5.0h2.001v15H3.5V0zm15 4.001h2V15h-2V4.001z" /></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120904581-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41082619-2');</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"blog","name":"Zenoh overhead: a story from our community","headline":"Zenoh overhead: a story from our community","datePublished":"2021-07-05 00:00:00 \x2b0000 UTC","dateModified":"2021-07-05 00:00:00 \x2b0000 UTC","url":"\/blog\/2021-07-05-zenoh-overhead\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"5057","wordCount":"1564","keywords":[],"description":"05 July 2021 -- Paris."}</script></header><div class="container-fluid ato-blog"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><div class="ato-docs-toggle d-md-none p-0 d-flex ml-3 collapsed align-item-center"><h1 class=ato-title>Zenoh overhead: a story from our community</h1><button class="btn btn-link" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><nav class="ato-links collapse" id=ato-docs-nav><div class="ato-toc-item active"><p class=ato-toc-link>Blog Posts</p><ul class="nav ato-sidenav"><li><a href=../../blog/2021-06-14-zenoh-reliability/>Zenoh Reliability, Scalability and Congestion Control</a></li><li><a href=../../blog/2020-01-01-zenohtude/>A Year Full of Zenoh</a></li><li><a href=../../blog/2020-06-29-zenoh-tidings/>Zenoh Tidings</a></li><li><a href=../../blog/2020-10-08-aithusa/>Zenoh Aithusa Hatched Out!</a></li><li><a href=../../blog/2021-03-23-discovery/>Minimizing Discovery Overhead in ROS2</a></li><li><a href=../../blog/2021-04-28-ros2-integration/>Integrating ROS2 with Eclipse zenoh</a></li><li><a href=../../blog/2021-07-05-zenoh-overhead/ class=active>Zenoh overhead: a story from our community</a></li><li><a href=../../blog/2021-07-13-zenoh-performance-async/>Zenoh performance: a stroll in Rust async wonderland</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#variable-length-encoding-a-compact-integer-representation>Variable Length Encoding: a compact integer representation</a><ul><li><a href=#smart-mapping-of-resource-keys-using-ids>Smart mapping of resource keys: using IDs</a></li></ul></li></ul><ul><li><a href=#configurable-sequence-number-resolution-just-the-right-size>Configurable Sequence Number resolution: just the right size</a></li><li><a href=#automatic-batching-everybody-on-board>Automatic batching: everybody on-board!</a></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>Zenoh overhead: a story from our community</h1><p class=ato-date>05 July 2021 -- Paris.</p><p>Zenoh&rsquo;s webpage states that zenoh has a minimal wire overhead of <strong>5 bytes</strong>. This is the result of careful considerations in the zenoh design: from using <strong>Variable Length Encoding (VLE)</strong>, to efficient <strong>mapping of resource keys</strong> and <strong>automatic batching</strong>.</p><p>If you are intrigued about this and want to know more, rest assured that you are not alone. In fact, the minimal overhead aspect of zenoh attracted a lot of attention and curiosity in our community that led to some interesting discussions on zenoh&rsquo;s <a href=https://gitter.im/atolab/zenoh>gitter channel</a>.</p><p>Given the amount of messages and information exchanged, we thought it would be a good idea to write a blog post to explain how zenoh achieves this wire efficiency. It&rsquo;s easier to read a blog post than scrolling backwards many messages on Gitter, isn&rsquo;t it?</p><h1 id=minimal-overhead-what-is-it>Minimal overhead: what is it?</h1><p>Let&rsquo;s start from the beginning. We said that 5 bytes are the minimal overhead in zenoh. What does that mean? It means that zenoh adds at least 5 bytes to user payload but, as you might have guessed, it may also add more if necessary. You might be wondering now in which cases zenoh offers the minimal overhead. To answer these questions we should first have a look at how zenoh serializes data on the wire.</p><p>As shown below, user payload is always carried in a zenoh data message. In turn, one or more zenoh data messages are carried within a zenoh frame message. The inner details of these messages and their corresponding weight in the 5 bytes overhead are presented in the following.</p><pre><code>+-------+----------------+----------------+- ... -+
| FRAME | DATA(USER PLD) | DATA(USER PLD) |  ...  |
+-------+----------------+----------------+- ... -+
</code></pre><hr><h1 id=zenoh-data-messages-carrying-your-data>Zenoh data messages: carrying your data</h1><p>In zenoh, users deal with keys/values where each key is a path and is associated with a value. A key looks like just a Unix file system path, such as <code>/myhome/kitchen/temp</code>, and it represents a resource. For what concerns the value, it can be defined with different encodings (string, JSON, raw bytes buffer, etc.).</p><p>As a result, the data, i.e. the value, is always published to a given resource. Zenoh takes this information from the user and it includes it in a zenoh data message as shown below.
Particularly, the overhead in a zenoh data message is computed as follows:</p><ul><li><strong>1 byte</strong> for the <strong>data header</strong></li><li><strong>1+ bytes</strong> for the <strong>resource</strong></li><li><strong>1+ bytes</strong> to encode the <strong>user data length</strong></li></ul><p>As you can see, the minimum overhead added by the zenoh data message is <strong>3 bytes</strong>.</p><pre><code> 7 6 5 4 3 2 1 0
+---------------+          --+      --+
|  DATA HEADER  | 1 byte     |DATA    |OVERHEAD
+---------------+            |        |     
~   RESOURCE    ~ 1+ bytes   |        |
+---------------+            |        |
~ USER PLD LEN  ~ 1+ bytes   |        |
+---------------+            |      --+
~   USER PLD    ~ 1+ bytes   |      
+---------------+          --+      
</code></pre><h2 id=variable-length-encoding-a-compact-integer-representation>Variable Length Encoding: a compact integer representation</h2><p>But how can we get exactly 3 bytes of overhead? Let&rsquo;s start by looking at the user data length, which takes 1+ bytes.
This field contains the number of bytes of user payload and represents a <em>64-bit integer</em>.
Its particularity is that it is encoded as variable-length (VLE), meaning that the footprint on the wire depends on its value.</p><p>As you can imagine, a 64 bit integer always takes 8 bytes when encoded as is. Instead, while encoded as VLE the size on the wire depends on its value. For instance, encoding the value 64 always takes 1 byte on the wire even if it is a 64-bit integer.</p><p>According to VLE encoding, with the first byte you can encode up to the value <code>2^7-1</code>, i.e. 127.
This means that when the user payload is shorter than 128 bytes, the space taken to encode its length is only <strong>1 byte</strong>.</p><h3 id=smart-mapping-of-resource-keys-using-ids>Smart mapping of resource keys: using IDs</h3><p>Next, let&rsquo;s have a look at the resource field that encodes the resource key, which is represented by an arbitrary long key. This is very handy for the user who is completely free to define his own key structure, as complex and nested as he wants to be. However, transmitting the whole key without any transformation is not wire efficient at all.</p><p>For this reason, in zenoh we have a mechanism to do some dynamic mapping between the complete string form of the key into a more compact integer form, called simply resource ID. This means that we have a wire-efficient mapping for identifying resources departing from simple integers sent on the wire.
This resource ID is then encoded as VLE, thus the possibility to use only 1 byte.</p><p>In order to use this wire-efficient representation you may need to use the <code>declare_resource()</code> primitive in zenoh, which does exactly that under the hood.
The following Python code will send data messages with only 3 bytes overhead.</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>session <span style=color:#555>=</span> zenoh<span style=color:#555>.</span>net<span style=color:#555>.</span>open(conf)
rid <span style=color:#555>=</span> session<span style=color:#555>.</span>declare_resource(<span style=color:#c30>&#34;/myresource&#34;</span>)
session<span style=color:#555>.</span>write(rid, <span style=color:#c30>&#34;This is my payload&#34;</span>)
</code></pre></div><p>Summarizing, the minimal overhead in data messages is as little as <strong>3 bytes</strong> when the <code>declare_resource()</code> primitive is used and small payloads are sent.</p><hr><h1 id=zenoh-frame-messages-batching-your-data>Zenoh frame messages: batching your data</h1><p>So far we have discovered where 3 bytes out 5 of zenoh overhead come from. Where are the other 2? Those come from the frame message which always encapsulates one or more data messages as shown below. Particularly, the frame overhead is computed as follows:</p><ul><li><strong>1 byte</strong> for the <strong>frame header</strong></li><li><strong>1+ byte</strong> for the <strong>sequence number (SN)</strong></li></ul><pre><code> 7 6 5 4 3 2 1 0
+---------------+          --+       --+
| FRAME HEADER  + 1 byte     |FRAME    |OVERHEAD
+---------------+            |         |
~ SEQUENCE NUM  ~ 1+ bytes   |         |
+---------------+            |       --+
~    DATA MSG   ~ 3+ bytes   |
+---------------+            |         
       ...                  ... Multiple data messages
+---------------+          --+
</code></pre><h2 id=configurable-sequence-number-resolution-just-the-right-size>Configurable Sequence Number resolution: just the right size</h2><p>By default, zenoh uses 4 bytes resolution for the SN giving an upper bound to the SN to <code>2^28-1</code>.
As you might have imagined by now, the SN is encoded as VLE resulting in an actual wire overhead of 1, 2, 3 or 4 bytes depending on the SN value.</p><p>The default SN resolution is chosen to deal with high throughput transmissions. Indeed, the larger the SN window, the more messages you can have on the fly at the same time.
But what if we are not interested in transmitting at high rate but we are rather operating over constrained networks? If that&rsquo;s the case, you can reduce the SN resolution to 128 (i.e. <code>2^7</code>) so as to always use <strong>1 byte</strong> when encoding the SN.</p><p>It&rsquo;s important to remark that in zenoh the SN resolution is local to a single hop.
By doing so, you can optimize the SN resolution on the first hop over a constrained network while having a larger SN resolution in the routing backbone and optimize the throughput!</p><p>Assuming that we want to configure a SN resolution of 128, a zenoh configuration can be written as follows:</p><pre><code>seq_num_resolution=128
</code></pre><p>Let&rsquo;s assume the above configuration is then saved with the name savebandwidth.conf.
Then, you can test this configuration with a zenoh pub sub example as follows:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ git clone git@github.com:eclipse-zenoh/zenoh.git
$ <span style=color:#366>cd</span> zenoh
$ cargo build --release --examples
</code></pre></div><p>Then, let&rsquo;s start a subscriber in a first terminal window:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ./target/release/examples/zn_sub -c savebandwidth.conf
</code></pre></div><p>And let&rsquo;s start a publisher in a second terminal window:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ./target/release/examples/zn_pub -c savebandwidth.conf
</code></pre></div><p>Hurray! You are now using only 1 byte for the SN. You can verify that by running the above examples by setting the environment variable <code>RUST_LOG=debug</code>.
You should be able to a log similar to the following:</p><p><code>[2021-06-18T07:26:05Z DEBUG zenoh::net::protocol::session::manager] New session opened with 7FB1570440474917BD5B326F5A7BCFA9: whatami 2, sn resolution 128, initial sn tx 60, initial sn rx 81, is_local: true</code></p><p>If you see <code>sn resolution 128</code>, it means that the desired SN resolution has been configured.</p><h2 id=automatic-batching-everybody-on-board>Automatic batching: everybody on-board!</h2><p>There is another nice feature that zenoh offers in terms of optimizing overhead.
And probably the most important one: automatic batching.</p><p>When there are multiple data messages ready to be sent, zenoh packs multiple data messages within the same frame in such a way the overhead introduced by the frame header and SN is added only once.
So, this operation is done transparently and it doesn&rsquo;t require any user intervention.
Very neat, isn&rsquo;t it? But that&rsquo;s not all yet!</p><p>Automatic batching enables additional savings (and probably the most important ones) in terms of bandwidth savings: it reduces the overhead from underlying network layers (e.g., TCP/IP).
By packing all the user messages, only one syscall per frame is then made.
This leads to the fact that the overhead of the underlying layers is only added once per frame and not per data message.
This is a not-negligible savings especially for small user payload: up to thousands of small messages can fit in a single frame!</p><hr><h1 id=conclusions>Conclusions</h1><p>Summarizing, the minimal overhead in frame messages is as little as 2 bytes when the SN resolution is bounded to 128.
Moreover, the overhead of the SN (even the larger ones) are then equally shared across all the data messages in a single frame, leading to considerable bandwidth savings also in high throughput scenarios when batching comes really into play. This leaves us with a minimal overhead of just <strong>5 bytes</strong> when a single message is sent.</p><p>If you liked this blog post and you have more questions or simply curiosities on zenoh, don&rsquo;t hesitate to join our community on zenoh&rsquo;s <a href=https://gitter.im/atolab/zenoh>gitter channel</a>!</p><p><a href=https://github.com/Mallets/><strong>&ndash;LC</strong></a></p><div class=ato-next><b>Next up</b>: <a href=/blog/2021-07-13-zenoh-performance-async/>Zenoh performance: a stroll in Rust async wonderland</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../img/eclipse-foundation.svg style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i>GitHub</a></p><p><a href=https://gitter.im/atolab/zenoh><i class="fa fa fa-comments-o" aria-hidden=true></i>Gitter</a></p><p><a href=../../docs/overview/><i class="fa fa-info-circle" aria-hidden=true></i>About</a></p></div><div class=col-md-2><p><img src=../../img/zenoh-dragon.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2021 Eclipse Foundation</p><p>Build with <a href=https://gohugo.io/ target=_blank>HUGO</a></p><p>Theme inspired from: <a href=https://tokio.rs/ target=_blank>Tokio website theme</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script><script src=../../js/bootstrap.min.js></script><script src=../../js/highlight.js></script><script>$(function(){$("pre code").each(function(i,block){if(block.className.indexOf('language-rust')>=0){var new_content='';var lines=block.textContent.split('\n');for(var i=0;i<lines.length;i++){if(lines[i].indexOf('# ')==0||lines[i]=='#'){continue}
new_content+=lines[i].trimRight()+'\n';}
block.textContent=new_content.replace(/\n\n\n/g,"\n\n").trimRight();}
hljs.highlightBlock(block);});});</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({apiKey:'d7b5b785798fe748621bcaa8301a2201',indexName:'zenoh',inputSelector:'#search-input',debug:false});</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-41082619-2','auto');ga('send','pageview');}</script></body></html>