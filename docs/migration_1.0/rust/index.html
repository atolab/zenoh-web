<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../site.webmanifest><link rel=mask-icon href=../../../safari-pinned-tab.png><meta name=msapplication-TileImage content="/safari-pinned-tab.png"><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../../css/bootstrap-reboot.css><link rel=stylesheet href=../../../css/bootstrap.css><link rel=stylesheet href=../../../css/font-awesome.min.css><link rel=stylesheet href=../../../css/ato.css><link rel=stylesheet href=../../../css/syntax.css><link rel=alternate type=application/rss+xml href=../../../blog/index.xml><title>Rust · Zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar-expand navbar-dark d-flex flex-column flex-md-row align-items-md-center ato-navbar"><div class="d-flex flex-row justify-content-between pl-2 pr-2"><a class=navbar-brand href=../../../><img src=../../../img/zenoh-dragon-bg-150x163.png class=align-middle alt></a>
<button class="btn btn-link d-md-none p-0" type=button data-toggle=collapse data-target=#ato-nav aria-controls=ato-nav aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><div class="ato-links collapse pl-4 pl-md-0" id=ato-nav><ul class="navbar-nav flex-column flex-md-row"><li class=nav-item><a class=nav-link href=../../../>Home</a></li><li class=nav-item><a class="nav-link active" href=../../../docs/getting-started/first-app/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../../usecases/>Use Cases</a></li><li class=nav-item><a class=nav-link href=../../../community/>Community</a></li><li class=nav-item><a class=nav-link href=../../../adopters/>Adopters</a></li><li class=nav-item><a class=nav-link href=../../../media/>Media</a></li><li class=nav-item><a class=nav-link href=../../../blog/2025-07-11-zenoh-pico-peer-to-peer-unicast/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/zettascaletech target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://discord.gg/2GJ958VuHs target=_blank rel=noopener aria-label=Discord><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Discord</title><path fill="currentcolor" d="M13.545 2.907a13.227 13.227.0 00-3.257-1.011.05.05.0 00-.052.025c-.141.25-.297.577-.406.833a12.19 12.19.0 00-3.658.0 8.258 8.258.0 00-.412-.833.051.051.0 00-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041.0 00-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276.0 003.995 2.02.05.05.0 00.056-.019c.308-.42.582-.863.818-1.329a.05.05.0 00-.01-.059.051.051.0 00-.018-.011 8.875 8.875.0 01-1.248-.595.05.05.0 01-.02-.066.051.051.0 01.015-.019c.084-.063.168-.129.248-.195a.05.05.0 01.051-.007c2.619 1.196 5.454 1.196 8.041.0a.052.052.0 01.053.007c.08.066.164.132.248.195a.051.051.0 01-.004.085 8.254 8.254.0 01-1.249.594.05.05.0 00-.03.03.052.052.0 00.003.041c.24.465.515.909.817 1.329a.05.05.0 00.056.019 13.235 13.235.0 004.001-2.02.049.049.0 00.021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034.0 00-.02-.019zm-8.198 7.307c-.789.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.45.73 1.438 1.613.0.888-.637 1.612-1.438 1.612zm5.316.0c-.788.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.451.73 1.438 1.613.0.888-.631 1.612-1.438 1.612z"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q target=_blank rel=noopener aria-label=Youtube><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Youtube</title><path fill="currentcolor" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01.0 011.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007.0 01-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309.0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007.0 01-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82.082 9.716A31.4 31.4.0 010 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007.0 011.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788.0 017.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=G-PBD6MS51QL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PBD6MS51QL")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"docs","name":"Rust","headline":"Rust","datePublished":"0001-01-01 00:00:00 \u002b0000 UTC","dateModified":"0001-01-01 00:00:00 \u002b0000 UTC","url":"\/docs\/migration_1.0\/rust\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"1011","wordCount":"2425","keywords":[],"description":"Module reorganization We reorganized the module tree, so import paths are not the same as before. The main difference is that everything should be imported via the root path zenoh::. Here are some examples, but you can look into zenoh\/src\/lib.rs for the complete list of changes.\n\/\/ common use use zenoh::config::*; use zenoh::{Config, Error, Result}; \/\/ key_expr \u0026amp; selector use zenoh::key_expr::{ format::{kedefine, keformat}, keyexpr, KeyExpr, OwnedKeyExpr, }; \/\/ session use zenoh::session::{init, open, EntityId, Session, SessionInfo}; \/\/ publisher \u0026amp; subscriber use zenoh::pubsub::{Publisher, Reliability, Subscriber}; \/\/ query \u0026amp; queryable \u0026amp; selectors use zenoh::query::{ ConsolidationMode, Parameters, Query, QueryConsolidation, QueryTarget, Queryable, Reply, Selector, }; \/\/ ZBytes \u0026amp; encoding use zenoh::bytes::{ZBytes, Encoding}; \/\/ sample use zenoh::sample::{Locality, Sample}; \/\/ quality of service use zenoh::qos::{CongestionControl, Priority, QoSBuilderTrait}; Removal of the sync and async preludes Zenoh preludes has been deprecated and are no more used in the API."}</script></header><div class="container-fluid ato-docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><div class="ato-search d-flex justify-content-end"><button class="btn btn-link ato-search-docs-toggle d-md-none p-0 ml-3" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></div><nav class="ato-links collapse" id=ato-docs-nav><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/overview/what-is-zenoh/>Overview</a><ul class="nav ato-sidenav"><li><a href=../../../docs/overview/what-is-zenoh/>What is Zenoh?</a></li><li><a href=../../../docs/overview/zenoh-in-action/>Zenoh in action</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/getting-started/first-app/>Getting started</a><ul class="nav ato-sidenav"><li><a href=../../../docs/getting-started/first-app/>Your first Zenoh app</a></li><li><a href=../../../docs/getting-started/installation/>Installation</a></li><li><a href=../../../docs/getting-started/deployment/>Deployment</a></li><li><a href=../../../docs/getting-started/quick-test/>For a quick test using Docker</a></li><li><a href=../../../docs/getting-started/troubleshooting/>Troubleshooting</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/manual/abstractions/>Reference manual</a><ul class="nav ato-sidenav"><li><a href=../../../docs/manual/abstractions/>Abstractions</a></li><li><a href=../../../docs/manual/configuration/>Configuration</a></li><li><a href=../../../docs/manual/plugins/>Zenoh plugins</a></li><li><a href=../../../docs/manual/plugin-http/>REST plugin</a></li><li><a href=../../../docs/manual/plugin-storage-manager/>Storage manager plugin</a></li><li><a href=../../../docs/manual/tls/>TLS authentication</a></li><li><a href=../../../docs/manual/quic/>QUIC transport</a></li><li><a href=../../../docs/manual/user-password/>User-Password authentication</a></li><li><a href=../../../docs/manual/access-control/>Access Control</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/apis/rust/>API</a><ul class="nav ato-sidenav"><li><a href=../../../docs/apis/rust/>Rust API</a></li><li><a href=../../../docs/apis/c/>C API</a></li><li><a href=../../../docs/apis/pico/>Pico API</a></li><li><a href=../../../docs/apis/cpp/>C++ API</a></li><li><a href=../../../docs/apis/python/>Python API</a></li><li><a href=../../../docs/apis/rest/>REST API</a></li><li><a href=../../../docs/apis/kotlin/>Kotlin API</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/migration_0.5_to_0.6/migrationguide-v0.5.x-v0.6.x/>Migration guides v0.5.x → v0.6.x</a><ul class="nav ato-sidenav"><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x to Zenoh v0.6.x</a></li><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-rust-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x Rust API to Zenoh v0.6.x Rust API</a></li><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-c-v0.5.x-v0.6.x/>Migrating from Zenoh-C v0.5.x zenoh-net API to Zenoh-C v0.6.x zenoh API</a></li><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-python-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x Python API to Zenoh v0.6.x Python API</a></li><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-pico-v0.5.x-v0.6.x/>Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x</a></li><li><a href=../../../docs/migration_0.5_to_0.6/migrationguide-zenohc-zenohpico/>Migrating from Zenoh-C to Zenoh-Pico (and vice-versa)</a></li></ul></div><div class="ato-toc-item active"><a class=ato-toc-link href=../../../docs/migration_1.0/concepts/>Migration guides v0.11 → v1.0</a><ul class="nav ato-sidenav"><li><a href=../../../docs/migration_1.0/concepts/>Concepts</a></li><li><a href=../../../docs/migration_1.0/rust/ class=active>Rust</a></li><li><a href=../../../docs/migration_1.0/c++/>C++</a></li><li><a href=../../../docs/migration_1.0/c_pico/>C / Pico</a></li><li><a href=../../../docs/migration_1.0/python/>Python</a></li><li><a href=../../../docs/migration_1.0/java/>Java</a></li><li><a href=../../../docs/migration_1.0/kotlin/>Kotlin</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#module-reorganization>Module reorganization</a></li><li><a href=#removal-of-the-sync-and-async-preludes>Removal of the sync and async preludes</a></li><li><a href=#session-is-now-clonable-and-can-be-closed-easily><code>Session</code> is now clonable and can be closed easily</a></li><li><a href=#callbacks-run-in-background-until-session-is-closed>Callbacks run in background until session is closed</a></li><li><a href=#value-is-gone-long-live-zbytes>Value is gone, long live ZBytes</a></li><li><a href=#serialization>Serialization</a></li><li><a href=#encoding>Encoding</a></li><li><a href=#attachment>Attachment</a></li><li><a href=#api-changes-in-query--queryable>API changes in Query & Queryable</a></li><li><a href=#use-accessors-to-get-private-members>Use accessors to get private members</a></li><li><a href=#support-ringchannel-to-receive-data>Support RingChannel to receive data</a></li><li><a href=#timestamps>Timestamps</a></li><li><a href=#feature-flags>Feature Flags</a></li><li><a href=#storage>Storage</a><ul><li><a href=#required-option-timestamping-enabled>Required option: <code>timestamping</code> enabled</a></li><li><a href=#rewrite-of-the-replication>Rewrite of the Replication</a></li></ul></li><li><a href=#shared-memory>Shared Memory</a><ul><li><a href=#sharedmemorymanager--shmprovider--shmproviderbackend>SharedMemoryManager → ShmProvider + ShmProviderBackend</a></li><li><a href=#buffer-allocation>Buffer allocation</a></li></ul></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>Rust</h1><div class=github-edit><a class="fa fa-github" href=https://github.com/atolab/zenoh-web/tree/master/content/docs/migration_1.0/Rust.md>Edit on GitHub</a></div><h2 id=module-reorganization>Module reorganization</h2><p>We reorganized the module tree, so import paths are not the same as before. The main difference is that everything should be imported via the root path <code>zenoh::</code>. Here are some examples, but you can look into <code>zenoh/src/lib.rs</code> for the complete list of changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// common use
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::config::<span style=color:#555>*</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::{Config,<span style=color:#bbb> </span>Error,<span style=color:#bbb> </span><span style=color:#366>Result</span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// key_expr &amp; selector
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::key_expr::{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>format::{kedefine,<span style=color:#bbb> </span>keformat},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>keyexpr,<span style=color:#bbb> </span>KeyExpr,<span style=color:#bbb> </span>OwnedKeyExpr,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// session
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::session::{init,<span style=color:#bbb> </span>open,<span style=color:#bbb> </span>EntityId,<span style=color:#bbb> </span>Session,<span style=color:#bbb> </span>SessionInfo};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// publisher &amp; subscriber
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::pubsub::{Publisher,<span style=color:#bbb> </span>Reliability,<span style=color:#bbb> </span>Subscriber};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// query &amp; queryable &amp; selectors
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::query::{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ConsolidationMode,<span style=color:#bbb> </span>Parameters,<span style=color:#bbb> </span>Query,<span style=color:#bbb> </span>QueryConsolidation,<span style=color:#bbb> </span>QueryTarget,<span style=color:#bbb> </span>Queryable,<span style=color:#bbb> </span>Reply,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Selector,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// ZBytes &amp; encoding
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::bytes::{ZBytes,<span style=color:#bbb> </span>Encoding};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// sample
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::sample::{Locality,<span style=color:#bbb> </span>Sample};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// quality of service
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::qos::{CongestionControl,<span style=color:#bbb> </span>Priority,<span style=color:#bbb> </span>QoSBuilderTrait};<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=removal-of-the-sync-and-async-preludes>Removal of the sync and async preludes</h2><p>Zenoh preludes has been deprecated and are no more used in the API. The API has also been made asynchronous first: all operations like put/get/etc. can be awaited directly.
Making synchronous calls now requires to import <code>zenoh::Wait</code>, and use <code>wait()</code> method, replacing the old <code>res()</code> method.
To make the migration easier, there is a deprecation prompt if you use the old API convention.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// (deprecated) async
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::prelude::r#async::<span style=color:#555>*</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).res().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>publisher<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.declare_publisher(<span style=color:#555>&amp;</span>key_expr).res().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>put.res().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// (deprecated) sync
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::prelude::sync::<span style=color:#555>*</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).res().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>publisher<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.declare_publisher(<span style=color:#555>&amp;</span>key_expr).res().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>put.res().unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// async
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Difference 1: No more res()
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>publisher<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.declare_publisher(<span style=color:#555>&amp;</span>key_expr).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>publisher.put(buf).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// sync
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Difference 2: use wait() for synchronous API
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::Wait;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).wait().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>publisher<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.declare_publisher(<span style=color:#555>&amp;</span>key_expr).wait().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>publisher.put(buf).wait().unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=session-is-now-clonable-and-can-be-closed-easily><code>Session</code> is now clonable and can be closed easily</h2><p><code>Session</code> implements <code>Clone</code> now, so there is no more need to wrap it into an <code>Arc&lt;Session></code>, and <code>Session::into_arc</code> has been deprecated. All the session methods, except <code>Session::close</code>, works like before, so only the session type need to be changed.
As a side effect, <code>Subscriber</code> and <code>Queryable</code> no longer have a generic lifetime parameter. <code>Publisher</code> also looses one of its lifetime parameters, to keep only the one of its key expression.</p><p>The session is now closed automatically when the last <code>Session</code> instance is dropped, <strong>even if publishers/subscribers/etc. are still alive</strong>. Session can also be manually closed using <code>Session::close</code>, which now takes an immutable reference, so it can be called anytime, even if publishers/subscribers/etc. are still alive.
Subscriber and queryable of a closed session will no longer receive data; trying to call <code>Session::get</code>, <code>Session::put</code> or <code>Publisher::put</code> will result in an error. Closing session on the fly may save bandwidth on the wire, as it avoids propagating the undeclaration of remaining entities like subscribers/queryables/etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>subscriber<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.declare_subscriber(<span style=color:#c30>&#34;key/expression&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>subscriber_task<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>tokio::spawn(<span style=color:#069;font-weight:700>async</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>move</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(sample)<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>subscriber.recv_async().<span style=color:#069;font-weight:700>await</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>println!(<span style=color:#c30>&#34;Received: {} {:?}&#34;</span>,<span style=color:#bbb> </span>sample.key_expr(),<span style=color:#bbb> </span>sample.payload());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// session can be closed while subscriber is still running, preventing it
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// receiving more data
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>session.close().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// subscriber task will end as `subscriber.recv_async()` will return `Err`
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// **when all remaining data has been processed**.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// subscriber undeclaration has not been sent on the wire
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>subscriber_task.<span style=color:#069;font-weight:700>await</span>.unwrap()<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=callbacks-run-in-background-until-session-is-closed>Callbacks run in background until session is closed</h2><p>It is now possible to declare &ldquo;background&rdquo; entities, e.g. subscribers, which have their callback called until the session is closed. So it is no longer needed to keep a dummy variable in scope when the intent is to have an entity living for the rest of the program.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.declare_subscriber(<span style=color:#c30>&#34;key/ expression&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.callback(<span style=color:#555>|</span>sample<span style=color:#555>|</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>println!(<span style=color:#c30>&#34;Received: {} {:?}&#34;</span>,<span style=color:#bbb> </span>sample.<span style=color:#bbb> </span>key_expr(),<span style=color:#bbb> </span>sample.<span style=color:#bbb> </span>payload())<span style=color:#bbb> </span>})<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.background()<span style=color:#bbb> </span><span style=color:#09f;font-style:italic>// declare the subscriber in background
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// subscriber runs in background until the session is closed
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// no need to keep a variable around
</span></span></span></code></pre></div><h2 id=value-is-gone-long-live-zbytes>Value is gone, long live ZBytes</h2><p><code>Value</code> has been split into <code>ZBytes</code> and <code>Encoding</code>. <code>put</code> and other operations now require a <code>ZBytes</code> payload, and builders accept an optional <code>Encoding</code> parameter. The encoding is no longer automatically inferred from the payload type.</p><p><code>ZBytes</code> is a raw bytes container, which can also contain non-contiguous regions of memory. It can be created directly from raw bytes/strings using <code>ZBytes::from</code>. The bytes can be retrieved using <code>ZBytes::to_bytes</code>, which returns a <code>Cow&lt;[u8]></code>, as a copy may have to be done if the underlying bytes are not contiguous.</p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>sample<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>subscriber.recv_async().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>value: <span style=color:#0a8;font-weight:700>Value</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>sample.value;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>raw_bytes: <span style=color:#366>Vec</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>u8</span><span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>value.try_into().unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>sample<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>subscriber.recv_async().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>zbytes: <span style=color:#0a8;font-weight:700>ZBytes</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>sample.payload();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>raw_bytes: <span style=color:#0a8;font-weight:700>Cow</span><span style=color:#555>&lt;</span>[<span style=color:#078;font-weight:700>u8</span>]<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zbytes.as_bytes();<span style=color:#bbb>
</span></span></span></code></pre></div><p>You can look at a full set of examples in <a href=https://github.com/eclipse-zenoh/zenoh/blob/1.0.0-beta.4/examples/examples/z_bytes.rs><code>examples/examples/z_bytes.rs</code></a>.</p><h2 id=serialization>Serialization</h2><p>Zenoh does provide serialization for convenience as an extension in the <code>zenoh-ext</code> crate. Serialization is implemented for a bunch of standard types like integers, floats, <code>Vec</code>, <code>HashMap</code>, etc. and is used through functions <code>z_serialize</code>/<code>z_deserialize</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>input: <span style=color:#366>Vec</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>f32</span><span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>vec![<span style=color:#f60>0.0</span>,<span style=color:#bbb> </span><span style=color:#f60>1.5</span>,<span style=color:#bbb> </span><span style=color:#f60>42.0</span>];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>payload: <span style=color:#0a8;font-weight:700>ZBytes</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>z_serialize(<span style=color:#555>&amp;</span>input);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>output: <span style=color:#366>Vec</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>f32</span><span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>z_deserialize(<span style=color:#555>&amp;</span>payload).unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>zenoh-ext</code> serialization doesn&rsquo;t pretend to cover all use cases, as it is just one available choice among other serialization formats like JSON, Protobuf, CBOR, etc. In the end, Zenoh will just send and receive payload raw bytes independently of the serialization used.</p><p>NOTE: ⚠️ Serialization of <code>Vec&lt;u8></code> is not the same as creating a <code>ZBytes</code> from a <code>Vec&lt;u8></code>: the resulting <code>ZBytes</code> are different, and serialization doesn&rsquo;t take ownership of the bytes.</p><h2 id=encoding>Encoding</h2><p><code>Encoding</code> has been reworked.
Zenoh does not impose any encoding requirement on the user, nor does it operate on it.
It can be thought of as optional metadata, carried over by Zenoh in such a way that the end user’s application may perform different operations based on encoding.
We have expanded our list of pre-defined encoding types from Zenoh 0.11.0 for user convenience.
The module path and name of the encoding have also changed.</p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::prelude::KnownEncoding;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.put(<span style=color:#555>&amp;</span>key_expr,<span style=color:#bbb> </span>payload)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.encoding(KnownEncoding::AppOctetStream)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.res()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>zenoh::encoding::Encoding;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.put(<span style=color:#555>&amp;</span>key_expr,<span style=color:#bbb> </span>payload)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.encoding(Encoding::APPLICATION_OCTET_STREAM)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><p>Users can also define their own encoding scheme that does not need to be based on the pre-defined variants.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>encoding<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>Encoding::from(<span style=color:#c30>&#34;pointcloud/LAS&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>Because encoding is now optional for <code>put</code>, <code>Publisher</code> can be declared with a default encoding, which will be used in every <code>Publisher::put</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>publisher<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.declare_publisher(<span style=color:#c30>&#34;my/keyepxr&#34;</span>).encoding(Encoding::APPLICATION_JSON).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// default encoding from publisher `application/json`
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>publisher.put(serde_json::to_vec(json<span style=color:#555>!</span>({<span style=color:#c30>&#34;key&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;value&#34;</span>})).unwrap()).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=attachment>Attachment</h2><p>In Zenoh 0.11.x, the <code>AttachmentBuilder</code> was required to create an attachment.
In Zenoh 1.0.0, we have removed <code>AttachmentBuilder</code>, and an attachment can be created from anything that implements <code>Into&lt;ZBytes></code></p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>mut</span><span style=color:#bbb> </span>attachment<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>AttachmentBuilder::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>attachment.insert(<span style=color:#c30>&#34;key1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;value1&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>attachment.insert(<span style=color:#c30>&#34;key2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;value2&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>publisher.put(payload)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		  	 </span>.with_attachment(attachment.build())<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		  	 </span>.res()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		  	 </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		  	 </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// Difference 1: No AttachmentBuilder anymore
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>//               Accept any type which can be transformed into ZBytes
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>mut</span><span style=color:#bbb> </span>hashmap<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>HashMap::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>hashmap.insert(<span style=color:#366>String</span>::from(<span style=color:#c30>&#34;key1&#34;</span>),<span style=color:#bbb> </span><span style=color:#366>String</span>::from(<span style=color:#c30>&#34;value1&#34;</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>hashmap.insert(<span style=color:#366>String</span>::from(<span style=color:#c30>&#34;key2&#34;</span>),<span style=color:#bbb> </span><span style=color:#366>String</span>::from(<span style=color:#c30>&#34;value2&#34;</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>the_attachment<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>ZBytes::from(<span style=color:#555>&amp;</span>hashmap);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// Difference 2: no with_attachment()
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>publisher<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.put(payload)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.attachment(the_attachment)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=api-changes-in-query--queryable>API changes in Query & Queryable</h2><p>Query and Queryable have been slightly reworked.</p><p>For the API replying to a <code>Query</code> from a <code>Queryable</code> declared on a session:
The reply function has been split into 3 separate functions variants depending on the type of reply the user wants to send.</p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>reply_ok<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(Sample::new(key_expr.clone(),<span style=color:#bbb> </span>payload.clone()));<span style=color:#bbb> </span><span style=color:#09f;font-style:italic>// Success
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>query.reply(reply_ok).res().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// or 
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>reply_err<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#366>Err</span>(Value::from(payload.clone()));<span style=color:#bbb>                 </span><span style=color:#09f;font-style:italic>// Failure
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>query.reply(reply_err).res().<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// No need to send Result
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// For sending Succesful Reply to Query
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>query.reply(key_expr.clone(),<span style=color:#bbb> </span>payload.clone()).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>  </span><span style=color:#09f;font-style:italic>// Success
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// For sending Error Reply to Query
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>query.reply_err(payload.clone()).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>                </span><span style=color:#09f;font-style:italic>// Failure
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// For sending Delete reply to Query (Sample Kind = Delete)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>query.reply_del(payload.clone()).<span style=color:#069;font-weight:700>await</span>.unwrap();<span style=color:#bbb>                </span><span style=color:#09f;font-style:italic>// Delete (Success)
</span></span></span></code></pre></div><p>For how a Get <code>Query</code> receives the reply:
use <code>result()</code> on the <code>Reply</code> to get the <code>&Sample</code>,
or <code>into_result</code> to take the ownership of the <code>Sample</code>.</p><p><code>Ok</code> variant replies, will return <code>Sample</code>.
<code>Err</code> variant replies, will return <code>ReplyError</code></p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(reply)<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>replies.recv_async().<span style=color:#069;font-weight:700>await</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>match</span><span style=color:#bbb> </span>reply.sample<span style=color:#bbb> </span>{<span style=color:#bbb>  </span><span style=color:#09f;font-style:italic>// sample should be Result&lt;Sample, Value&gt;
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#366>Ok</span>(sample)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#c30>&#34;&gt;&gt; Received (&#39;{}&#39;: &#39;{}&#39;)&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>sample.key_expr.as_str(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>sample.value,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#366>Err</span>(value_err)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>println!(<span style=color:#c30>&#34;{}&#34;</span>,<span style=color:#bbb> </span><span style=color:#366>String</span>::try_from(<span style=color:#555>&amp;</span>value_err).unwrap()),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(reply)<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>replies.recv_async().<span style=color:#069;font-weight:700>await</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#09f;font-style:italic>// Difference 1: using result() to get Result&lt;&amp;Sample, &amp;ReplyError&gt;
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>match</span><span style=color:#bbb> </span>reply.result()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#366>Ok</span>(sample)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#c30>&#34;&gt;&gt; Received (&#39;{}&#39;: &#39;{}&#39;)&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>sample.key_expr().as_str(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#09f;font-style:italic>// Difference 2: payload() instead of value
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>                </span>sample.payload().deserialize::<span style=color:#555>&lt;</span><span style=color:#366>String</span><span style=color:#555>&gt;</span>().unwrap()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#09f;font-style:italic>// Difference 3: ReplyError instead of Value
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#366>Err</span>(err)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>println!(<span style=color:#c30>&#34;{}&#34;</span>,<span style=color:#bbb> </span>err.payload().deserialize::<span style=color:#555>&lt;</span><span style=color:#366>String</span><span style=color:#555>&gt;</span>().unwrap());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>We have also added the ability to get underlying Handlers from <code>Queryables</code>, so that users have direct acces to the receiver of the data channel.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>queryable<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.declare_queryable(<span style=color:#555>&amp;</span>key_expr)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>handler: <span style=color:#069>&amp;</span><span style=color:#0a8;font-weight:700>Receiver</span><span style=color:#555>&lt;</span>Query<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>queryable.handler();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// or mutable handler
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>mut_handler:<span style=color:#069>&amp;</span><span style=color:#0a8;font-weight:700>mut</span><span style=color:#bbb> </span>Receiver<span style=color:#555>&lt;</span>Query<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>queryable.handler_mut();<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=use-accessors-to-get-private-members>Use accessors to get private members</h2><p>We encapsulate members of structs, and they can’t be accessed directly now.
The only way to access Struct values is to use the getter function associated with them.
Let’s take the subscriber as an example here.</p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(sample)<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>subscriber.recv_async().<span style=color:#069;font-weight:700>await</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#c30>&#34;&gt;&gt; [Subscriber] Received {} (&#39;{}&#39;: &#39;{}&#39;)&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.kind,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.key_expr.as_str(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.value<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#366>Ok</span>(sample)<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>subscriber.recv_async().<span style=color:#069;font-weight:700>await</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#c30>&#34;&gt;&gt; [Subscriber] Received {} (&#39;{}&#39;: &#39;{:?}&#39;)&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.kind(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.key_expr().as_str(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>sample.payload()<span style=color:#bbb>  </span><span style=color:#09f;font-style:italic>// Ignore the deserialization
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>    </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=support-ringchannel-to-receive-data>Support RingChannel to receive data</h2><p>Besides using a callback to receive data, we can also receive the data from a default FIFO channel. However, sometimes we only care about the latest data and want to discard the oldest data.
We can use <code>RingChannel</code> to get this behaviour.
You can take a look at the complete code in <code>examples/examples/z_pull.rs</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>subscriber<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.declare_subscriber(<span style=color:#555>&amp;</span>key_expr)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.with(RingChannel::new(size))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:#069;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><p>⚠️ Note: We <strong>no longer</strong> support <strong>Pull</strong> mode in Zenoh</p><p>To get the same behavior of a Zenoh 0.11.0 <code>PullSubscriber</code>, please make use of a <code>RingChannel</code> an example of this is illustrated in <code>z_pull.rs</code>.</p><h2 id=timestamps>Timestamps</h2><p>We now tie generating a timestamp to a Zenoh session, with the timestamp inheriting the <code>ZenohID</code> of the session.</p><p>Note that a Zenoh session will only be able to generate a timestamp if the <code>timestamping</code> configuration option is enabled.</p><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>timestamp<span style=color:#bbb> </span>: <span style=color:#0a8;font-weight:700>Timestamp</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb>  </span>zenoh::time::new_reception_timestamp();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>session: <span style=color:#0a8;font-weight:700>Session</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>zenoh::open(config);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// If the `timestamping` configuration is disabled, this call will return `None`.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>timestamp: <span style=color:#366>Option</span><span style=color:#555>&lt;</span>Timestamp<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session::new_timestamp();<span style=color:#bbb>
</span></span></span></code></pre></div><p>This will affect user-created plugins and applications that need to generate timestamps.</p><h2 id=feature-flags>Feature Flags</h2><p>Removed:</p><ul><li><code>complete_n</code>: due to a Legacy code cleanup</li></ul><h2 id=storage>Storage</h2><h3 id=required-option-timestamping-enabled>Required option: <code>timestamping</code> enabled</h3><p>Zenoh 1.0.0 introduced the possibility for Zenoh nodes configured in a mode other than <code>router</code> to load plugins.</p><p>A, somehow, implicit assumption that dictated the behaviour of storages is that the Zenoh node loading them <strong>has to add a timestamp to any received publication that did not have one</strong>. This functionality is controlled by the <code>timestamping</code> configuration option.</p><p>Until Zenoh 1.0.0 this assumption held true as only a router could load storage and the default configuration for a router enables <code>timestamping</code>. However, in Zenoh 1.0.0 nodes configured in <code>client</code> & <code>peer</code> mode can load storage and <em>their default configuration disables <code>timestamping</code></em>.</p><p>⚠️ The <code>storage-manager</code> will fail to launch if the <code>timestamping</code> configuration option is disabled.</p><h3 id=rewrite-of-the-replication>Rewrite of the Replication</h3><p>We have completely rewritten the Replication functionality in Zenoh 1.0.0. The core of the algorithm did not change, hence if you are interested in its inner workings, <a href=https://zenoh.io/blog/2022-11-29-zenoh-alignment/>our blog post unveiling this functionality</a> still provides an accurate overview.</p><p>This rewrite was an opportunity to integrate many of the improvements we introduced in Zenoh since this feature was first developed. In particular, the older version was not leveraging Queryable as, at the time, they did not allow carrying attachments or payloads.</p><p>We also used this rewrite to slightly rework the configuration thus, if you were using this functionality before Zenoh 1.0.0, you will have to update the configuration of all your replicated Storage. The following configuration summarises the changes:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#c30>&#34;plugins&#34;</span><span style=color:#a00;background-color:#faa>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#309;font-weight:700>&#34;storage_manager&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#309;font-weight:700>&#34;storages&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#309;font-weight:700>&#34;replication-test&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#309;font-weight:700>&#34;volume&#34;</span>: <span style=color:#c30>&#34;memory&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#309;font-weight:700>&#34;key_expr&#34;</span>: <span style=color:#c30>&#34;test/replication/*&#34;</span>,
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// ⚠️ This field must be identical for all Replicated Storage.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>        <span style=color:#309;font-weight:700>&#34;strip_prefix&#34;</span>: <span style=color:#c30>&#34;test/replication&#34;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// ⚠️ This field was previously called `replica_config`.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>        <span style=color:#309;font-weight:700>&#34;replication&#34;</span>: {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#09f;font-style:italic>// ⚠️ This field was previously called `publication_interval`.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>          <span style=color:#309;font-weight:700>&#34;interval&#34;</span>: <span style=color:#f60>10</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#09f;font-style:italic>// ⚠️ This field replaces `delta`.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>          <span style=color:#309;font-weight:700>&#34;sub_intervals&#34;</span>: <span style=color:#f60>5</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#09f;font-style:italic>// This field did not change.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>          <span style=color:#309;font-weight:700>&#34;propagation_delay&#34;</span>: <span style=color:#f60>250</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#09f;font-style:italic>// ⚠️ These fields are new.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>          <span style=color:#309;font-weight:700>&#34;hot&#34;</span>: <span style=color:#f60>6</span>,
</span></span><span style=display:flex><span>          <span style=color:#309;font-weight:700>&#34;warm&#34;</span>: <span style=color:#f60>30</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The new <code>hot</code> and <code>warm</code> fields expose parts of the Replication algorithm. They express how many intervals are included in the Hot and Warm Eras respectively. These values control how much information is included in the Replication Digest: the higher these values are, the more information are included in the Digest (consuming more bandwidth for each Digest) but, at the same time, a misalignment will be detected and resolved faster (consuming less bandwidth when aligning).</p><p>Finally, in 1.0.0, only Replicas configured with <strong>exactly the same parameters</strong> will interact. This is to avoid burdening the network for no reason: if Replicas with a different configuration were to interact, they would always assume they are misaligned as, because of their different configuration, they would compute different Digests &mdash; even when they are aligned.</p><p>The parameters that must be identical are: <code>key_expr</code>, <code>strip_prefix</code> and all the fields in <code>replication</code> (i.e. <code>interval</code>, <code>sub_intervals</code>, <code>propagation_delay</code>, <code>hot</code> and <code>warm</code>).</p><p>Note that configuring Replicas differently is equivalent to creating Replication groups: only Replicas with exactly the same configuration belong to the same group.</p><h2 id=shared-memory>Shared Memory</h2><p>Shared Memory subsystem is heavily reworked and improved. The key functionality changes:</p><ul><li>Buffer reference counting is now robust across abnormal process termination</li><li>Support plugging of user-defined SHM implementations</li><li>Dynamic SHM transport negotiation: Sessions are interoperable with any combination of SHM configuration and physical location</li><li>Support aligned allocations</li><li>Manual buffer invalidation</li><li>Buffer write access</li><li>Rich buffer allocation interface</li></ul><p>⚠️ Please note that SHM API is still unstable and will be improved in the future.</p><h3 id=sharedmemorymanager--shmprovider--shmproviderbackend>SharedMemoryManager → ShmProvider + ShmProviderBackend</h3><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>id<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>session.zid().to_string();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>shmem_size<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>1024</span><span style=color:#555>*</span><span style=color:#f60>1024</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>mut</span><span style=color:#bbb> </span>manager<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>SharedMemoryManager::make(id,<span style=color:#bbb> </span>shmem_size).unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// Create an SHM backend...
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>shmem_size<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>1024</span><span style=color:#555>*</span><span style=color:#f60>1024</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// Difference: each SHM Provider needs a backend that defines it&#39;s implementation
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// details, like SHM system API used and allocation startegy
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>backend<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>PosixShmProviderBackend::builder()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.with_size(shmem_size)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.res()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// ...and an SHM provider
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>provider<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>ShmProviderBuilder::builder()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.protocol_id::<span style=color:#555>&lt;</span>POSIX_PROTOCOL_ID<span style=color:#555>&gt;</span>()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.backend(backend)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.res();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#09f;font-style:italic>// Difference: SHMProvider is not pinned to particular Session ID and it&#39;s
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// buffers are OK to be published in different Sessions
</span></span></span></code></pre></div><p>⚠️ Backend implements <code>ShmProviderBackend</code> trait and user is free to create custom backends.</p><h3 id=buffer-allocation>Buffer allocation</h3><ul><li>Zenoh 0.11.x</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// Allocate SHM buffer
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>mut</span><span style=color:#bbb> </span>sbuf<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>match</span><span style=color:#bbb> </span>manager.alloc(<span style=color:#f60>1024</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#366>Ok</span>(buf)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>buf,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#366>Err</span>(_)<span style=color:#bbb> </span><span style=color:#555>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>tokio::time::sleep(Duration::from_millis(<span style=color:#f60>100</span>)).<span style=color:#069;font-weight:700>await</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#c30>&#34;After failing allocation the GC collected: {} bytes -- retrying&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>manager.garbage_collect()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>println!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#c30>&#34;Trying to de-fragment memory... De-fragmented {} bytes&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>manager.defragment()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>manager.alloc(<span style=color:#f60>1024</span>).unwrap()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Zenoh 1.0.0</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#09f;font-style:italic>// Allocate SHM buffer
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>mut</span><span style=color:#bbb> </span>sbuf<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>provider<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.alloc(<span style=color:#f60>1024</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#09f;font-style:italic>// Difference: there is a rich set of policies available to control
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#09f;font-style:italic>// allocation behavior and handle allocation failures automatically
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#bbb>    </span>.with_policy::<span style=color:#555>&lt;</span>BlockOn<span style=color:#555>&lt;</span>Defragment<span style=color:#555>&lt;</span>GarbageCollect<span style=color:#555>&gt;&gt;&gt;</span>()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.wait()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></div><div class=ato-next><b>Next up</b>: <a href=/docs/migration_1.0/c++/>C++</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../../img/eclipse-foundation.svg style=width:120px></a></p><p><a href=https://zettascale.tech target=_blank><img src=../../../img/zettascale-dark.svg style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i>
GitHub</a></p><p><a href=https://discord.gg/vSDSpqnbkm><i class="fa fa fa-comments-o" aria-hidden=true></i>
Discord</a></p><p><a href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q><i class="fa fa-youtube-play" aria-hidden=true></i> Youtube</a></p><p><a href=../../../docs/overview/what-is-zenoh><i class="fa fa-info-circle" aria-hidden=true></i> About</a></p></div><div class=col-md-2><p><img src=../../../img/zenoh-dragon-150x163.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2022 Eclipse Foundation</p><p>Built with <a href=https://gohugo.io/ target=_blank>HUGO</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script>
<script src=../../../js/bootstrap.min.js></script>
<script src=../../../js/highlight.min.js></script>
<script>$(function(){$("pre code").each(function(e,t){if(t.className.indexOf("language-rust")>=0){for(var s="",n=t.textContent.split(`
`),e=0;e<n.length;e++){if(n[e].indexOf("# ")==0||n[e]=="#")continue;s+=n[e].trimRight()+`
`}t.textContent=s.replace(/\n\n\n/g,`

`).trimRight()}hljs.highlightBlock(t)})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PBD6MS51QL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PBD6MS51QL",{anonymize_ip:!1})}</script></body></html>