<!doctype html><html lang=en><head><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../site.webmanifest><link rel=mask-icon href=../../../safari-pinned-tab.png><meta name=msapplication-TileImage content="/safari-pinned-tab.png"><meta name=msapplication-TileColor content="#7da7d8"><meta name=theme-color content="#7da7d8"><meta charset=utf-8><meta name=description content="Eclipse Zenoh, unify data in motion, data at rest and computations."><meta name=keywords content="pub/sub,query,geo distributed storage,Rust,protocol,DDS,MQTT,Edge,IoT,MEC"><meta name=author content="The Zenoh Team"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=../../../css/bootstrap-reboot.css><link rel=stylesheet href=../../../css/bootstrap.css><link rel=stylesheet href=../../../css/font-awesome.min.css><link rel=stylesheet href=../../../css/ato.css><link rel=stylesheet href=../../../css/syntax.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css><link rel=alternate type=application/rss+xml href=../../../blog/index.xml><title>Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x Â· Zenoh - pub/sub, geo distributed storage, query</title></head><body><header class="navbar navbar-expand navbar-dark flex-column flex-md-row ato-navbar"><a class=navbar-brand href=../../../><img src=../../../img/zenoh-dragon-bg.png class=align-middle alt></a><div class="collapse navbar-collapse"><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../../>Home</a></li><li class=nav-item><a class="nav-link active" href=../../../docs/getting-started/first-app/>Documentation</a></li><li class=nav-item><a class=nav-link href=../../../usecases/>Use Cases</a></li><li class=nav-item><a class=nav-link href=../../../community/>Community</a></li><li class=nav-item><a class=nav-link href=../../../adopters/>Adopters</a></li><li class=nav-item><a class=nav-link href=../../../media/>Media</a></li><li class=nav-item><a class=nav-link href=../../../blog/2022-08-12-zenoh-serial/>Blog</a></li></ul></div><ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex"><li class=nav-item><a class="nav-link p-2" href=https://github.com/eclipse-zenoh/zenoh target=_blank rel=noopener aria-label=GitHub><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64.0.0 114.61.0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34.0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49.0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75.0.0 21.49-6.88 70.4 26.24a242.65 242.65.0 01128.18.0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69.0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41.0 34.22-.31 61.83-.31 70.23.0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37.0 256 0z" fill="currentcolor" fill-rule="evenodd"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://twitter.com/atolab_ target=_blank rel=noopener aria-label=Twitter><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2.0 298.92-160.22 298.92-298.92.0-4.51.0-9-.2-13.52A214 214 0 00512 49.38a212.93 212.93.0 01-60.44 16.6 105.7 105.7.0 0046.3-58.19 209 209 0 01-66.79 25.37 105.09 105.09.0 00-181.73 71.91 116.12 116.12.0 002.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48.0 0068 159.6a106.27 106.27.0 01-47.53-13.11v1.43a105.28 105.28.0 0084.21 103.06 105.67 105.67.0 01-47.33 1.84 105.06 105.06.0 0098.14 72.94A210.72 210.72.0 0125 370.84a202.17 202.17.0 01-25-1.43 298.85 298.85.0 00160.83 46.92" fill="currentcolor"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://discord.gg/vSDSpqnbkm target=_blank rel=noopener aria-label=Discord><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Discord</title><path fill="currentcolor" d="M13.545 2.907a13.227 13.227.0 00-3.257-1.011.05.05.0 00-.052.025c-.141.25-.297.577-.406.833a12.19 12.19.0 00-3.658.0 8.258 8.258.0 00-.412-.833.051.051.0 00-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041.0 00-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276.0 003.995 2.02.05.05.0 00.056-.019c.308-.42.582-.863.818-1.329a.05.05.0 00-.01-.059.051.051.0 00-.018-.011 8.875 8.875.0 01-1.248-.595.05.05.0 01-.02-.066.051.051.0 01.015-.019c.084-.063.168-.129.248-.195a.05.05.0 01.051-.007c2.619 1.196 5.454 1.196 8.041.0a.052.052.0 01.053.007c.08.066.164.132.248.195a.051.051.0 01-.004.085 8.254 8.254.0 01-1.249.594.05.05.0 00-.03.03.052.052.0 00.003.041c.24.465.515.909.817 1.329a.05.05.0 00.056.019 13.235 13.235.0 004.001-2.02.049.049.0 00.021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034.0 00-.02-.019zm-8.198 7.307c-.789.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.45.73 1.438 1.613.0.888-.637 1.612-1.438 1.612zm5.316.0c-.788.0-1.438-.724-1.438-1.612.0-.889.637-1.613 1.438-1.613.807.0 1.451.73 1.438 1.613.0.888-.631 1.612-1.438 1.612z"/></svg></a></li><li class=nav-item><a class="nav-link p-2" href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q target=_blank rel=noopener aria-label=Youtube><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Youtube</title><path fill="currentcolor" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01.0 011.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007.0 01-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309.0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007.0 01-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82.082 9.716A31.4 31.4.0 010 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007.0 011.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788.0 017.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120904581-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-41082619-2")</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":""},"articleSection":"docs","name":"Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x","headline":"Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x","datePublished":"0001-01-01 00:00:00 \u002b0000 UTC","dateModified":"0001-01-01 00:00:00 \u002b0000 UTC","url":"\/docs\/migration\/migrationguide-pico-v0.5.x-v0.6.x\/","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"1011","wordCount":"1599","keywords":[],"description":"General considerations about the new Zenoh-Pico v0.6.x API Ownership model The new Zenoh-Pico API, similarly to the Zenoh-C API, introduced a more explicit ownership model to the user. Such model targets a better memory management where e.g. memory leaks can be easily identified and double free can be avoided. The user will have a clear understanding on what is owned by his side of the code, and what has been loaned or moved to the API."}</script></header><div class="container-fluid ato-docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 ato-sidebar"><form class="ato-search d-flex align-items-center"><span class="algolia-autocomplete algolia-autocomplete-left" style=position:relative;display:inline-block;direction:ltr><input class="form-control ds-input" id=search-input placeholder=Search... autocomplete=off spellcheck=false role=combobox aria-autocomplete=list aria-expanded=false aria-owns=algolia-autocomplete-listbox-0 style=position:relative;vertical-align:top dir=auto type=search><pre aria-hidden=true style="position:absolute;visibility:hidden;white-space:pre;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol;font-size:16px;font-style:normal;font-variant:normal;font-weight:400;word-spacing:0;letter-spacing:normal;text-indent:0;text-rendering:optimizelegibility;text-transform:none">w</pre><span class="ds-dropdown-menu ds-with-1" style=position:absolute;top:100%;left:0;z-index:100;right:auto;display:none role=listbox id=algolia-autocomplete-listbox-0><div class=ds-dataset-1></div></span></span><button class="btn btn-link ato-search-docs-toggle d-md-none p-0 ml-3" type=button data-toggle=collapse data-target=#ato-docs-nav aria-controls=ato-docs-nav aria-expanded=false aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"/></svg></button></form><nav class="ato-links collapse" id=ato-docs-nav><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/overview/what-is-zenoh/>Overview</a><ul class="nav ato-sidenav"><li><a href=../../../docs/overview/what-is-zenoh/>What is Zenoh?</a></li><li><a href=../../../docs/overview/zenoh-in-action/>Zenoh in action</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/getting-started/first-app/>Getting started</a><ul class="nav ato-sidenav"><li><a href=../../../docs/getting-started/first-app/>Your first Zenoh app</a></li><li><a href=../../../docs/getting-started/installation/>Installation</a></li><li><a href=../../../docs/getting-started/deployment/>Deployment</a></li><li><a href=../../../docs/getting-started/quick-test/>For a quick test using Docker</a></li><li><a href=../../../docs/getting-started/troubleshooting/>Troubleshooting</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/manual/abstractions/>Reference manual</a><ul class="nav ato-sidenav"><li><a href=../../../docs/manual/abstractions/>Abstractions</a></li><li><a href=../../../docs/manual/configuration/>Configuration</a></li><li><a href=../../../docs/manual/plugins/>Zenoh plugins</a></li><li><a href=../../../docs/manual/plugin-http/>REST plugin</a></li><li><a href=../../../docs/manual/plugin-storage-manager/>Storage manager plugin</a></li><li><a href=../../../docs/manual/tls/>TLS authentication</a></li><li><a href=../../../docs/manual/quic/>QUIC transport</a></li><li><a href=../../../docs/manual/user-password/>User-Password authentication</a></li></ul></div><div class=ato-toc-item><a class=ato-toc-link href=../../../docs/apis/rust/>API</a><ul class="nav ato-sidenav"><li><a href=../../../docs/apis/rust/>Rust API</a></li><li><a href=../../../docs/apis/c/>C API</a></li><li><a href=../../../docs/apis/python/>Python API</a></li><li><a href=../../../docs/apis/rest/>REST API</a></li></ul></div><div class="ato-toc-item active"><a class=ato-toc-link href=../../../docs/migration/migrationguide-v0.5.x-v0.6.x/>Migration guides</a><ul class="nav ato-sidenav"><li><a href=../../../docs/migration/migrationguide-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x to Zenoh v0.6.x</a></li><li><a href=../../../docs/migration/migrationguide-rust-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x Rust API to Zenoh v0.6.x Rust API</a></li><li><a href=../../../docs/migration/migrationguide-c-v0.5.x-v0.6.x/>Migrating from Zenoh-C v0.5.x zenoh-net API to Zenoh-C v0.6.x zenoh API</a></li><li><a href=../../../docs/migration/migrationguide-python-v0.5.x-v0.6.x/>Migrating from Zenoh v0.5.x Python API to Zenoh v0.6.x Python API</a></li><li><a href=../../../docs/migration/migrationguide-pico-v0.5.x-v0.6.x/ class=active>Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x</a></li><li><a href=../../../docs/migration/migrationguide-zenohc-zenohpico/>Migrating from Zenoh-C to Zenoh-Pico (and vice-versa)</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 ato-toc"><div class=section-nav><nav id=TableOfContents><ul><li><a href=#general-considerations-about-the-new-zenoh-pico-v06x-api>General considerations about the new Zenoh-Pico v0.6.x API</a><ul><li><a href=#ownership-model>Ownership model</a></li><li><a href=#private-functions-types-and-constants>Private functions, types and constants</a></li></ul></li><li><a href=#migrating-from-zenoh-pico-v05x-zenoh-net-api-to-zenoh-pico-v06x-zenoh-api>Migrating from Zenoh-Pico v0.5.x zenoh-net API to Zenoh-Pico v0.6.x zenoh API</a><ul><li><a href=#opening-a-session>Opening a session</a></li><li><a href=#subscribing>Subscribing</a></li><li><a href=#publishing>Publishing</a></li><li><a href=#querying>Querying</a></li><li><a href=#queryable>Queryable</a></li><li><a href=#read-and-lease-tasks>Read and Lease tasks</a></li><li><a href=#examples>Examples</a></li></ul></li></ul></nav></div></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 ato-content ato-docs"><h1 class=ato-title>Migrating from Zenoh-Pico v0.5.x to Zenoh-Pico v0.6.x</h1><div class=github-edit><a class="fa fa-github" href=https://github.com/atolab/zenoh-web/tree/master/content/docs/migration/MigrationGuide-Pico-v0.5.x-v0.6.x.md>Edit on GitHub</a></div><h2 id=general-considerations-about-the-new-zenoh-pico-v06x-api>General considerations about the new Zenoh-Pico v0.6.x API</h2><h3 id=ownership-model>Ownership model</h3><p>The new Zenoh-Pico API, similarly to the Zenoh-C API, introduced a more explicit ownership model to the user. Such model targets a better memory management where e.g. memory leaks can be easily identified and double free can be avoided. The user will have a clear understanding on what is owned by his side of the code, and what has been loaned or moved to the API.</p><p>In a nutshell,</p><ol><li><p>For each Zenoh type in the API, there are in fact two types: an <strong>owned</strong> (e.g., <code>z_owned_*_t</code>) and a <strong>loaned</strong> (e.g., <code>z_*_t</code>) type. For example, <code>z_session_t</code> has an equivalent defined as <code>z_owned_session_t</code>. While the former is a borrowed/loaned object (meaning, the user does not need to release it), the latter is owned by the user and thus the user is responsible to release it.</p></li><li><p>A set of ownership helpers, <code>z_move</code>, <code>z_loan</code>, <code>z_check</code> and <code>z_drop</code> are provided to ease the management of owned objects and defines how an object is passed to the API.</p></li></ol><ul><li>With <code>z_move</code>, the user give the ownership of an owned object to the API, meaning that the user no longer owns the object and therefore the user is no more responsible for releasing it.</li><li>With <code>z_loan</code>, the user retain the ownership of the owned object upon return of the API call. <strong>Note that, releasing an object while loan references still exist causes undefined behavior.</strong></li><li>With <code>z_check</code>, the user can check if a owned object is valid, which also means that it retains memory to be released before going out of scope.</li><li>With <code>z_drop</code>, the user can release the memory associated to a given owned object. Although <code>z_drop</code> is double-free safe, loaned references to the object that might still live might cause undefined behavior.</li></ul><h3 id=private-functions-types-and-constants>Private functions, types and constants</h3><p>In the new Zenoh-Pico API, any private function, type or constant is prefixed with a <code>_z_*</code> or <code>_Z_*</code>. The user <strong>must not use them</strong>, since we will not guarantee their stability or even existence. Users might solely use any function, type or constant that starts with a <code>z_*</code> or <code>Z_*</code>
Also, any struct members denotated with a <code>_</code> are also private and <strong>must not be used</strong>. All the remaning members can be used, and we plan to keep them stable.</p><h2 id=migrating-from-zenoh-pico-v05x-zenoh-net-api-to-zenoh-pico-v06x-zenoh-api>Migrating from Zenoh-Pico v0.5.x zenoh-net API to Zenoh-Pico v0.6.x zenoh API</h2><h3 id=opening-a-session>Opening a session</h3><p>All types and operations from the <code>zn_*</code> primitives have been updated and migrated to the <code>z_*</code> primitives.</p><p><em>zenoh v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zn_properties_t <span style=color:#555>*</span>config <span style=color:#555>=</span> zn_config_default();
</span></span><span style=display:flex><span>zn_session_t <span style=color:#555>*</span>s <span style=color:#555>=</span> zn_open(config);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (s <span style=color:#555>==</span> <span style=color:#366>NULL</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to open session!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_owned_config_t config <span style=color:#555>=</span> z_config_default();
</span></span><span style=display:flex><span>z_owned_session_t s <span style=color:#555>=</span> z_open(z_move(config));
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_check(s)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to open session!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_owned_config_t config <span style=color:#555>=</span> z_config_default();
</span></span><span style=display:flex><span>z_owned_session_t s <span style=color:#555>=</span> z_open(z_config_move(<span style=color:#555>&amp;</span>config));
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_session_check(<span style=color:#555>&amp;</span>s)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to open session!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=subscribing>Subscribing</h3><p>For this release, Zenoh-Pico only supports subscribers with callbacks. It is possible to access samples through a callback by calling the <code>callback</code> function passed as argument on <code>declare_subscriber</code> function.</p><p>When declaring a subscriber, keyexpr optimizations
(i.e., keyexpr declaration) will be automatically performed if required.</p><p>Finer configuration is performed with the help of an options struct.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>data_handler</span>(<span style=color:#069;font-weight:700>const</span> zn_sample_t <span style=color:#555>*</span>sample, <span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>arg)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Subscription listener] Received (%.*s, %.*s)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>,
</span></span><span style=display:flex><span>           (<span style=color:#078;font-weight:700>int</span>)sample<span style=color:#555>-&gt;</span>key.len, sample<span style=color:#555>-&gt;</span>key.val,
</span></span><span style=display:flex><span>           (<span style=color:#078;font-weight:700>int</span>)sample<span style=color:#555>-&gt;</span>value.len, sample<span style=color:#555>-&gt;</span>value.val);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>zn_subscriber_t <span style=color:#555>*</span>sub <span style=color:#555>=</span> zn_declare_subscriber(s, zn_rname(<span style=color:#c30>&#34;/key/expression&#34;</span>), zn_subinfo_default(), data_handler, <span style=color:#366>NULL</span>);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>data_handler</span>(<span style=color:#069;font-weight:700>const</span> z_sample_t <span style=color:#555>*</span>sample, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>arg)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(sample<span style=color:#555>-&gt;</span>keyexpr);
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Subscriber] Received (&#39;%s&#39;: &#39;%.*s&#39;)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>,
</span></span><span style=display:flex><span>           keystr, (<span style=color:#078;font-weight:700>int</span>)sample<span style=color:#555>-&gt;</span>payload.len, sample<span style=color:#555>-&gt;</span>payload.start);
</span></span><span style=display:flex><span>    free(keystr);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_owned_closure_sample_t callback <span style=color:#555>=</span> z_closure(data_handler);
</span></span><span style=display:flex><span>z_owned_subscriber_t sub <span style=color:#555>=</span> z_declare_subscriber(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), z_move(callback), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_check(sub)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare subscriber.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>data_handler</span>(<span style=color:#069;font-weight:700>const</span> z_sample_t <span style=color:#555>*</span>sample, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>arg)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(sample<span style=color:#555>-&gt;</span>keyexpr);
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Subscriber] Received (&#39;%s&#39;: &#39;%.*s&#39;)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>,
</span></span><span style=display:flex><span>           keystr, (<span style=color:#078;font-weight:700>int</span>)sample<span style=color:#555>-&gt;</span>payload.len, sample<span style=color:#555>-&gt;</span>payload.start);
</span></span><span style=display:flex><span>    free(keystr);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_owned_closure_sample_t callback <span style=color:#555>=</span> z_closure_sample(data_handler, <span style=color:#366>NULL</span>, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>z_owned_subscriber_t sub <span style=color:#555>=</span> z_declare_subscriber(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), z_closure_sample_move(<span style=color:#555>&amp;</span>callback), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_subscriber_check(<span style=color:#555>&amp;</span>sub)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare subscriber.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=publishing>Publishing</h3><p>The <code>write</code> operation has been replaced by a <code>put</code> operation.</p><p>When declaring a publisher, keyexpr optimizations (i.e., keyexpr declaration) will be automatically performed if required.</p><p>Finer configuration is performed with the help of an options struct.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zn_write(s, reskey, <span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>));
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_put(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Put has failed!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_put(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Put has failed!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>write_ext</code> operation has been removed. Configuration is now performed with the help of a option struct.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zn_write_ext(s, reskey, <span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), Z_ENCODING_TEXT_PLAIN, Z_DATA_KIND_DEFAULT, zn_congestion_control_t_BLOCK);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_put_options_t options <span style=color:#555>=</span> z_put_options_default();
</span></span><span style=display:flex><span>options.congestion_control <span style=color:#555>=</span> Z_CONGESTION_CONTROL_DROP;
</span></span><span style=display:flex><span>options.encoding <span style=color:#555>=</span> z_encoding(Z_ENCODING_PREFIX_TEXT_PLAIN, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>options.priority <span style=color:#555>=</span> Z_PRIORITY_DATA;
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_put(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#555>&amp;</span>options) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Put has failed!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_put_options_t options <span style=color:#555>=</span> z_put_options_default();
</span></span><span style=display:flex><span>options.congestion_control <span style=color:#555>=</span> Z_CONGESTION_CONTROL_DROP;
</span></span><span style=display:flex><span>options.encoding <span style=color:#555>=</span> z_encoding(Z_ENCODING_PREFIX_TEXT_PLAIN, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>options.priority <span style=color:#555>=</span> Z_PRIORITY_DATA;
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_put(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#555>&amp;</span>options) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Put has failed!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>declare_publisher</code> now returns a publisher object upon which <code>put</code> and <code>delete</code> operations can be performed.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zn_publisher_t <span style=color:#555>*</span>pub <span style=color:#555>=</span> zn_declare_publisher(s, reskey);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (pub <span style=color:#555>==</span> <span style=color:#366>NULL</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare publisher.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_owned_publisher_t pub <span style=color:#555>=</span> z_declare_publisher(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_check(pub)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare publisher!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>z_publisher_put(z_loan(pub), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>z_owned_publisher_t pub <span style=color:#555>=</span> z_declare_publisher(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_publisher_check(<span style=color:#555>&amp;</span>pub)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare publisher!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>z_publisher_put(z_publisher_loan(<span style=color:#555>&amp;</span>pub), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>);
</span></span></code></pre></div><h3 id=querying>Querying</h3><p>The <code>query_collect</code> operation has been replaced by a <code>get</code> operation. The <code>get</code> operation is no longer blocking and returning a list of replies, but instead it makes replies accessible through a callback by calling the <code>callback</code> function passed as argument on <code>get</code> function.</p><p>When declaring a publisher, keyexpr optimizations (i.e., keyexpr declaration) will be automatically performed if required.</p><p>Finer configuration is performed with the help of an options struct.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zn_reply_data_array_t replies <span style=color:#555>=</span> zn_query_collect(s, zn_rname(<span style=color:#c30>&#34;/key/expression&#34;</span>), <span style=color:#c30>&#34;&#34;</span>, zn_query_target_default(), zn_query_consolidation_default());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>unsigned</span> <span style=color:#078;font-weight:700>int</span> i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> replies.len; <span style=color:#555>++</span>i) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Reply handler] received (%.*s, %.*s)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>,
</span></span><span style=display:flex><span>            (<span style=color:#078;font-weight:700>int</span>)replies.val[i].data.key.len, replies.val[i].data.key.val,
</span></span><span style=display:flex><span>            (<span style=color:#078;font-weight:700>int</span>)replies.val[i].data.value.len, replies.val[i].data.value.val);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>zn_reply_data_array_free(replies);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>reply_dropper</span>(<span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; Received query final notification</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>reply_handler</span>(z_owned_reply_t <span style=color:#555>*</span>oreply, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (z_reply_is_ok(oreply)) {
</span></span><span style=display:flex><span>        z_sample_t sample <span style=color:#555>=</span> z_reply_ok(oreply);
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(sample.keyexpr);
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;&gt;&gt; Received (&#39;%s&#39;: &#39;%.*s&#39;)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, keystr, (<span style=color:#078;font-weight:700>int</span>)sample.payload.len, sample.payload.start);
</span></span><span style=display:flex><span>        free(keystr);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;&gt;&gt; Received an error</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_get_options_t opts <span style=color:#555>=</span> z_get_options_default();
</span></span><span style=display:flex><span>opts.target <span style=color:#555>=</span> Z_QUERY_TARGET_ALL;
</span></span><span style=display:flex><span>z_owned_closure_reply_t callback <span style=color:#555>=</span> z_closure(reply_handler, reply_dropper);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_get(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), <span style=color:#366>NULL</span>, z_move(callback), <span style=color:#555>&amp;</span>opts) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to send query.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>reply_dropper</span>(<span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; Received query final notification</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>reply_handler</span>(z_owned_reply_t <span style=color:#555>*</span>oreply, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (z_reply_is_ok(oreply)) {
</span></span><span style=display:flex><span>        z_sample_t sample <span style=color:#555>=</span> z_reply_ok(oreply);
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(sample.keyexpr);
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;&gt;&gt; Received (&#39;%s&#39;: &#39;%.*s&#39;)</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, keystr, (<span style=color:#078;font-weight:700>int</span>)sample.payload.len, sample.payload.start);
</span></span><span style=display:flex><span>        free(keystr);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        printf(<span style=color:#c30>&#34;&gt;&gt; Received an error</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_get_options_t opts <span style=color:#555>=</span> z_get_options_default();
</span></span><span style=display:flex><span>opts.target <span style=color:#555>=</span> Z_QUERY_TARGET_ALL;
</span></span><span style=display:flex><span>z_owned_closure_reply_t callback <span style=color:#555>=</span> z_closure_reply(reply_handler, reply_dropper, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (z_get(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), <span style=color:#c30>&#34;&#34;</span>, z_closure_reply_move(<span style=color:#555>&amp;</span>callback), <span style=color:#555>&amp;</span>opts) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to send query.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=queryable>Queryable</h3><p>It is possible to access queries through a callback by calling the <code>callback</code> function passed as argument on <code>declare_queryable</code> function.</p><p>When declaring a queryable, keyexpr optimizations (i.e., keyexpr declaration) will be automatically performed if required.</p><p>Finer configuration is performed with the help of an options struct.</p><p>The <code>send_reply</code> operation has been also extended with an options struct for finer configuration.</p><p><em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>query_handler</span>(zn_query_t <span style=color:#555>*</span>query, <span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    z_string_t res <span style=color:#555>=</span> zn_query_res_name(query);
</span></span><span style=display:flex><span>    z_string_t pred <span style=color:#555>=</span> zn_query_predicate(query);
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Query handler] Handling &#39;%.*s?%.*s&#39;</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, (<span style=color:#078;font-weight:700>int</span>)res.len, res.val, (<span style=color:#078;font-weight:700>int</span>)pred.len, pred.val);
</span></span><span style=display:flex><span>    zn_send_reply(query, <span style=color:#c30>&#34;/key/expression&#34;</span>, <span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>zn_queryable_t <span style=color:#555>*</span>qable <span style=color:#555>=</span> zn_declare_queryable(s, zn_rname(<span style=color:#c30>&#34;/key/expression&#34;</span>), ZN_QUERYABLE_EVAL, query_handler, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (qable <span style=color:#555>==</span> <span style=color:#366>NULL</span>) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to declare queryable.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>query_handler</span>(<span style=color:#069;font-weight:700>const</span> z_query_t <span style=color:#555>*</span>query, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(z_query_keyexpr(query));
</span></span><span style=display:flex><span>    z_bytes_t pred <span style=color:#555>=</span> z_query_parameters(query);
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Queryable ] Received Query &#39;%s%.*s&#39;</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, keystr, (<span style=color:#078;font-weight:700>int</span>)pred.len, pred.start);
</span></span><span style=display:flex><span>    z_query_reply(query, z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>    free(keystr);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_owned_closure_query_t callback <span style=color:#555>=</span> z_closure(query_handler);
</span></span><span style=display:flex><span>z_owned_queryable_t qable <span style=color:#555>=</span> z_declare_queryable(z_loan(s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), z_move(callback), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_check(qable)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to create queryable.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>query_handler</span>(<span style=color:#069;font-weight:700>const</span> z_query_t <span style=color:#555>*</span>query, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>ctx)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>keystr <span style=color:#555>=</span> z_keyexpr_to_string(z_query_keyexpr(query));
</span></span><span style=display:flex><span>    z_bytes_t pred <span style=color:#555>=</span> z_query_parameters(query);
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;&gt;&gt; [Queryable ] Received Query &#39;%s%.*s&#39;</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, keystr, (<span style=color:#078;font-weight:700>int</span>)pred.len, pred.start);
</span></span><span style=display:flex><span>    z_query_reply(query, z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), (<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span> <span style=color:#555>*</span>)<span style=color:#c30>&#34;value&#34;</span>, strlen(<span style=color:#c30>&#34;value&#34;</span>), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>    free(keystr);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// (...)
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span>z_owned_closure_query_t callback <span style=color:#555>=</span> z_closure_query(query_handler, <span style=color:#366>NULL</span>, <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>z_owned_queryable_t qable <span style=color:#555>=</span> z_declare_queryable(z_session_loan(<span style=color:#555>&amp;</span>s), z_keyexpr(<span style=color:#c30>&#34;key/expression&#34;</span>), z_closure_query_move(<span style=color:#555>&amp;</span>callback), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>z_queryable_check(<span style=color:#555>&amp;</span>qable)) {
</span></span><span style=display:flex><span>    printf(<span style=color:#c30>&#34;Unable to create queryable.</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>);
</span></span><span style=display:flex><span>    exit(<span style=color:#555>-</span><span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=read-and-lease-tasks>Read and Lease tasks</h3><p>As Zenoh-Pico is targeting microcontrollers and embedded systems, it is a requirement to support both single-thread and multi-thread implementations. To do so, the user has explicit control over the read and lease tasks.</p><p>If ### multi-thread behavior is intended, the user must spawn both tasks manually by including the following lines after Zenoh Session is successfully open.
<em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_start_read_task(s);
</span></span><span style=display:flex><span>zp_start_lease_task(s);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_start_read_task(z_loan(s), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>zp_start_lease_task(z_loan(s), <span style=color:#366>NULL</span>);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_start_read_task(z_session_loan(<span style=color:#555>&amp;</span>s), <span style=color:#366>NULL</span>);
</span></span><span style=display:flex><span>zp_start_lease_task(z_session_loan(<span style=color:#555>&amp;</span>s), <span style=color:#366>NULL</span>);
</span></span></code></pre></div><p>Likewise, the user must also destroy both tasks manually by including the following lines just before closing the session:
<em>zenoh-net v0.5.x</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_stop_read_task(s);
</span></span><span style=display:flex><span>zp_stop_lease_task(s);
</span></span></code></pre></div><p><em>zenoh v0.6.x (C11)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_stop_read_task(z_loan(s));
</span></span><span style=display:flex><span>zp_stop_lease_task(z_loan(s));
</span></span></code></pre></div><p><em>zenoh v0.6.x (C99)</em></p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>zp_stop_read_task(z_session_loan(<span style=color:#555>&amp;</span>s));
</span></span><span style=display:flex><span>zp_stop_lease_task(z_session_loan(<span style=color:#555>&amp;</span>s));
</span></span></code></pre></div><p>Note that, <code>z_close(z_move(s));</code> will stop and destroy the tasks if the user forgets to do it. However, for the sake of symmetric operations, the user is advised to stop them manually.</p><p>If <strong>single-thread behavior</strong> is intended, the user must not spawn the any of the tasks. Instead, the user can a single execution of the read task and lease tasks at its own pace:</p><p><em>zenoh v0.6.x (C11)</em></p><pre tabindex=0><code>zp_read(z_loan(s), NULL);
zp_send_keep_alive(z_loan(s), NULL);
zp_send_join(z_loan(s), NULL);
</code></pre><p><em>zenoh v0.6.x (C99)</em></p><pre tabindex=0><code>zp_read(z_session_loan(&amp;s), NULL);
zp_send_keep_alive(z_session_loan(&amp;s), NULL);
zp_send_join(z_session_loan(&amp;s), NULL);
</code></pre><h3 id=examples>Examples</h3><p>More examples are available here:</p><p><a href=https://github.com/eclipse-zenoh/zenoh-pico/tree/master/examples/unix/c11><em>zenoh v0.6.0 (C11)</em></a></p><p><a href=https://github.com/eclipse-zenoh/zenoh-pico/tree/master/examples/unix/c99><em>zenoh v0.6.0 (C99)</em></a></p><p><a href=https://github.com/eclipse-zenoh/zenoh-pico/tree/0.5.0-beta.9><em>zenoh-net v0.5.0-beta9</em></a></p><div class=ato-next><b>Next up</b>: <a href=/docs/migration/migrationguide-zenohc-zenohpico/>Migrating from Zenoh-C to Zenoh-Pico (and vice-versa)</a></div></main></div></div><footer class="ato-footer text-muted"><div class="container-fluid p-6 p-md-5"><div class=row><div class=col-md-2><h5>Eclipse Incubation</h5><p><img src=../../../img/eclipse-incubation.png style=width:100px></p><p>Eclipse zenoh &trade; is an incubating project under the Eclipse Foundation.</p></div><div class=col-md-2><h5>More Information</h5><p><a href=https://www.eclipse.org/legal target=_blank>Legal</a></p><p><a href=https://www.eclipse.org/legal/privacy.php target=_blank>Privacy policy</a></p><p><a href=https://www.eclipse.org/legal/termsofuse.php target=_blank>Terms of use</a></p><p><a href=https://www.eclipse.org/legal/copyright.php target=_blank>Copyright</a></p><p><a href=https://www.eclipse.org/security/ target=_blank>Report a security issue</a></p><p><a href=https://www.eclipse.org/legal/epl-2.0/ target=_blank>Eclipse Public License 2.0</a></p><p><a href=https://www.apache.org/licenses/LICENSE-2.0 target=_blank>Apache License 2.0</a></p><p><a href=https://www.eclipse.org/ target=_blank>Eclipse Foundation</a></p></div><div class=col-md-2><h5>Sponsored by:</h5><p><a href=https://www.eclipse.org target=_blank><img src=../../../img/eclipse-foundation.svg style=width:120px></a></p><p><a href=https://zettascale.tech target=_blank><img src=../../../img/zettascale-dark.svg style=width:120px></a></p></div><div class=col-md-2><h5>Follow us</h5><p><a href=https://github.com/eclipse-zenoh/zenoh><i class="fa fa-github" aria-hidden=true></i> GitHub</a></p><p><a href=https://discord.gg/vSDSpqnbkm><i class="fa fa fa-comments-o" aria-hidden=true></i> Discord</a></p><p><a href=https://www.youtube.com/channel/UCslbiyiqgOAPMjCrPWIfQ5Q><i class="fa fa-youtube-play" aria-hidden=true></i> Youtube</a></p><p><a href=../../../docs/overview/what-is-zenoh><i class="fa fa-info-circle" aria-hidden=true></i> About</a></p></div><div class=col-md-2><p><img src=../../../img/zenoh-dragon.png style=width:45px></p><p>Eclipse zenoh &trade; is free, open source and always will be.</p><p>Copyright &copy 2022 Eclipse Foundation</p><p>Built with <a href=https://gohugo.io/ target=_blank>HUGO</a></p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script>
<script src=../../../js/bootstrap.min.js></script>
<script src=../../../js/highlight.js></script>
<script>$(function(){$("pre code").each(function(e,t){if(t.className.indexOf("language-rust")>=0){for(var s="",n=t.textContent.split(`
`),e=0;e<n.length;e++){if(n[e].indexOf("# ")==0||n[e]=="#")continue;s+=n[e].trimRight()+`
`}t.textContent=s.replace(/\n\n\n/g,`

`).trimRight()}hljs.highlightBlock(t)})})</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script>
<script type=text/javascript>docsearch({apiKey:"d7b5b785798fe748621bcaa8301a2201",indexName:"zenoh",inputSelector:"#search-input",debug:!1})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41082619-2","auto"),ga("send","pageview"))</script></body></html>